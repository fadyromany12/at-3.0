<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>Konecta Adherence Portal (KAP)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Using Inter, a calm and highly legible font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart', 'table']});
      google.charts.setOnLoadCallback(() => { chartsLoaded = true; }); 
    </script>
    
    <style>
      /* --- Color Palette & Variables --- */
      :root {
        /* Konecta Branding */
        --konecta-blue: #00a9e0;
        --konecta-dark: #2101cd; 
        --konecta-yellow: #f0fa00; 
        
        /* Hint of Superadmin color for Admin/Superadmin elements, slightly toned down */
        --role-admin-header: #3b1f9b; 
        --role-admin-text: white; 

        /* Core UI - LIGHT MODE */
        --text-color: #212121; 
        --text-color-secondary: #5f6368; 
        --page-bg: #f4f7f6; 
        --card-bg: #ffffff;
        --border-color: #e0e0e0;
        --input-bg: #f8f9fa;
        --shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        --radius: 12px;

        /* Role Colors (User-Defined) - Simplified to just use for badge backgrounds */
        --role-user-bg: #f4f7f6; 
        --role-admin-bg: #f0fa00;
        --role-superadmin-bg: #2101cd;
      }

      /* DARK MODE OVERRIDES */
      body.dark-mode {
        --text-color: #f4f7f6;
        --text-color-secondary: #b0b0b0;
        --page-bg: #1e1e1e;
        --card-bg: #2d2d2d;
        --border-color: #444444;
        --input-bg: #3c3c3c;
        --shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        
        /* Adjusting role backgrounds for dark mode visibility */
        --role-user-bg: #252525; 
        --role-admin-bg: #a1a600; 
        --role-superadmin-bg: #0d015c; 
        --role-admin-header: #0d015c;
        --role-admin-text: #f4f7f6;
      }
      
      /* --- Global Transitions and Font --- */
      * {
        /* Set smooth transition for everything for the "advanced" feel */
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      }
      
      body, html {
        font-family: 'Inter', Arial, sans-serif;
        margin: 0; 
        padding: 0;
        background-color: var(--page-bg);
        color: var(--text-color); 
      }
      
      h1, h2, h3, h4, strong {
        color: var(--text-color); 
      }
      
      /* --- Role-Based Customization (Simplified) --- */
      /* All main content uses standard light/dark theme colors */
      
      body[data-role="admin"] header,
      body[data-role="superadmin"] header {
        background-color: var(--role-admin-header); /* Hint of Superadmin color */
        border-color: var(--role-admin-header);
      }
      body[data-role="admin"] header #logo-container,
      body[data-role="superadmin"] header #logo-container {
        border-color: var(--role-admin-header);
      }
      body[data-role="admin"] #admin-panel,
      body[data-role="superadmin"] #admin-panel {
        background-color: var(--role-admin-header);
        color: var(--role-admin-text);
        border-color: var(--role-admin-header);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }
      body[data-role="admin"] #admin-panel label,
      body[data-role="superadmin"] #admin-panel label {
        color: var(--role-admin-text);
      }


      /* --- Header with Logo and Dark Mode Button --- */
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 30px; 
        background-color: var(--card-bg);
        border-bottom: 2px solid var(--border-color);
        position: sticky; 
        top: 0;
        z-index: 100;
      }
      .header-controls {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      
      /* NEW: Logo Container Styling (Bordered Cool Rectangle) */
      #logo-container {
          padding: 10px 15px;
          background-color: var(--card-bg); 
          border: 2px solid var(--konecta-blue);
          border-radius: var(--radius);
          box-shadow: 0 4px 15px rgba(0, 169, 224, 0.2); 
          transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
          cursor: pointer;
      }
      #logo-container:hover {
          transform: translateY(-3px) scale(1.02);
          box-shadow: 0 8px 20px rgba(0, 169, 224, 0.4);
      }
      #konecta-logo {
        height: 40px; 
        width: auto;
        transition: none;
      }

      
      /* --- Dark Mode & Refresh Buttons --- */
      #header-refresh-button, #dark-mode-button {
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        cursor: pointer;
        padding: 10px; 
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      #header-refresh-button:hover, #dark-mode-button:hover {
        opacity: 0.9;
        transform: scale(1.1); 
        background-color: var(--page-bg);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      #header-refresh-button img, #dark-mode-button img {
        width: 18px;
        height: 18px;
      }
      #header-refresh-button.loading img {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* --- Centered Card Layout --- */
      main {
        max-width: 1100px;
        margin: 30px auto;
        background-color: var(--card-bg);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        /* Removed role-based borders on main content */
      }
      
      /* --- Enhanced Card/Item Animations (Advanced Feel) --- */
      .dashboard-card, .request-list-item, #agent-info, #admin-panel {
        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); 
        position: relative;
      }
      .dashboard-card:hover, .request-list-item:hover {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); 
        transform: translateY(-4px); 
      }
      
      /* --- Tab Navigation --- */
      #tab-nav {
        border-bottom: 1px solid var(--border-color);
        padding-top: 10px;
        display: flex;
        justify-content: flex-start; 
        overflow-x: auto; 
        padding-left: 30px;
        background-color: var(--card-bg);
      }
      .tab-button {
        padding: 14px 20px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        background-color: transparent;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        color: var(--text-color-secondary);
        white-space: nowrap; 
      }
      .tab-button:hover {
        background-color: var(--input-bg);
        color: var(--konecta-blue);
      }
      .tab-button.active {
        color: var(--konecta-blue);
        border-bottom: 3px solid var(--konecta-blue);
        background-color: var(--input-bg);
      }
      #schedule-tab-button, #leave-approval-tab-button, #admin-tools-tab-button, #history-report-tab-button, #dashboard-tab-button, #my-schedule-tab-button, #reporting-line-tab-button {
        display: none;
      }
      
      /* --- Content Container --- */
      .content-container {
        padding: 30px;
      }
      
      .tab-panel {
        display: none;
      }
      #punch-panel {
        display: block;
      }
      
      /* --- Info and Admin Panels --- */
      #agent-info { 
        margin-bottom: 20px; 
        padding: 15px;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        text-align: center;
        font-size: 1.1em;
        position: relative; 
      }
      
      #admin-panel {
        display: none;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 500;
      }
      #admin-panel label {
        font-weight: 600;
        margin-right: 10px;
        color: var(--text-color);
      }
      #agent-select {
        font-size: 1em;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
        color: var(--text-color);
      }

      /* --- Punch Button Group --- */
      #buttons, #other-buttons {
        padding: 0;
        background-color: transparent;
        border-radius: 0;
        box-shadow: none;
        text-align: center;
      }
      #buttons, #other-buttons {
         display: none;
      }
      
      #other-buttons {
        margin-top: 20px;
      }

      button {
        margin: 10px;
        padding: 14px 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        border-radius: 10px;
        background-color: var(--konecta-blue);
        color: white;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 10px rgba(0, 169, 224, 0.3); 
        transition: all 0.2s ease-out; 
        min-width: 160px;
      }
      button:hover {
        background-color: #008fbc;
        transform: translateY(-3px) scale(1.02); 
        box-shadow: 0 8px 18px rgba(0, 169, 224, 0.5); 
      }
      
      #other-buttons button {
        background-color: var(--text-color-secondary);
        box-shadow: 0 4px 10px rgba(95, 99, 104, 0.2);
      }
       #other-buttons button:hover {
        background-color: #3c4043;
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 18px rgba(95, 99, 104, 0.4);
      }
      
      .button-group {
        margin-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
      }
      .button-group:last-of-type {
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
      }
      
      /* --- Alert/Status Styles --- */
      .status-message {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        min-height: 30px;
        font-size: 1em;
        font-weight: 500;
        text-align: center;
        visibility: hidden;
        border: 1px solid transparent;
        opacity: 0;
        transition: opacity 0.4s ease, visibility 0.4s ease, transform 0.3s ease;
        transform: translateY(10px);
      }
      .status-message.visible {
        visibility: visible;
        opacity: 1;
        transform: translateY(0);
      }
      
      /* Base Style for all status containers */
      #status, #schedule-status, #leave-status, #approval-status, #my-history-status, #manual-punch-status, #admin-leave-status, #csv-import-status, #balance-adjust-status, #my-schedule-status, #dashboard-status, #reporting-line-status {
          /* Inherits status-message styles */
      }

      /* Success */
      .status-message.success { 
        background-color: #edfbf3; 
        color: #2a6944; 
        border-color: #b8e9c9;
      }
      body.dark-mode .status-message.success { 
        background-color: #1a4f2b; 
        color: #b8e9c9;
        border-color: #2a6944;
      }

      /* Error */
      .status-message.error { 
        background-color: #fdebee; 
        color: #c53030; 
        border-color: #fbb2b2;
      }
      body.dark-mode .status-message.error { 
        background-color: #7b1d1d; 
        color: #fbb2b2;
        border-color: #c53030;
      }
      
      /* Processing/Warning */
      .status-message.processing { 
        background-color: #feefc3; 
        color: #744210; 
        border-color: #f9da8a;
      }
      body.dark-mode .status-message.processing { 
        background-color: #4b2a0c; 
        color: #f9da8a;
        border-color: #744210;
      }
      
      /* --- Form Styles (reusable) --- */
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text-color-secondary); 
      }
      .form-group select, .form-group input, .form-group textarea {
        width: 100%;
        padding: 12px;
        font-size: 1em;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        box-sizing: border-box;
        background-color: var(--input-bg);
        color: var(--text-color);
        font-family: 'Inter', Arial, sans-serif;
      }
      .form-group input[type="date"], .form-group input[type="time"] {
        color-scheme: var(--dark-mode-scheme, light); 
      }
      body.dark-mode {
        --dark-mode-scheme: dark;
      }
      .form-row {
        display: flex;
        gap: 15px;
      }
      .form-row .form-group {
        flex: 1;
      }
      
      .form-group small {
        display: block;
        margin-top: 6px;
        font-size: 0.85rem;
        color: var(--text-color-secondary);
      }
      
      .form-container .submit-btn-green {
        background-color: #34a853;
        box-shadow: 0 4px 10px rgba(52, 168, 83, 0.3);
      }
      .form-container .submit-btn-green:hover {
        background-color: #2c8c45;
        box-shadow: 0 6px 15px rgba(52, 168, 83, 0.4);
      }
      
      /* --- Leave Balance Display --- */
      #leave-balances {
        display: flex;
        gap: 20px;
        margin-bottom: 25px;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 20px;
      }
      .balance-item {
        flex: 1;
        text-align: center;
      }
      .balance-item p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-color-secondary);
        font-weight: 500;
      }
      .balance-item .balance-days {
        font-size: 2rem;
        font-weight: 700;
        color: var(--konecta-blue);
        display: block;
        margin-top: 5px;
      }
      
      /* --- Leave List Styles --- */
      .request-list {
        margin-top: 30px;
        padding-top: 20px;
      }
      .request-list-item {
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-left: 5px solid var(--konecta-blue);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
        gap: 15px;
      }
      
      .request-list-item .item-details {
        flex: 1;
      }
      .request-list-item .item-details h4 {
        margin: 0 0 10px 0;
        color: var(--text-color);
        font-size: 1.1em;
      }
      .request-list-item .item-details p {
        margin: 4px 0;
        font-size: 0.95rem;
        color: var(--text-color-secondary);
      }
      .request-list-item .item-actions {
        min-width: 150px;
        text-align: right;
      }
      
      /* Status Badges */
      .status-badge {
        display: inline-block;
        padding: 6px 14px;
        font-size: 0.85rem;
        font-weight: 600;
        border-radius: 20px;
        margin-top: 5px;
        text-transform: uppercase;
      }
      .status-pending { background-color: #feefc3; color: #744210; }
      .status-approved { background-color: #edfbf3; color: #2a6944; }
      .status-denied { background-color: #fdebee; color: #c53030; }
      
      body.dark-mode .status-pending { background-color: #4b2a0c; color: #f9da8a; }
      body.dark-mode .status-approved { background-color: #1a4f2b; color: #b8e9c9; }
      body.dark-mode .status-denied { background-color: #7b1d1d; color: #fbb2b2; }

      .item-actions .approve-btn,
      .item-actions .deny-btn {
        min-width: 100px;
        padding: 8px 12px;
        font-size: 14px;
        margin: 4px;
        font-weight: 500;
        box-shadow: none;
        transform: none;
      }
      .approve-btn { background-color: #34a853; }
      .approve-btn:hover { background-color: #2c8c45; }
      .deny-btn { background-color: #ea4335; }
      .deny-btn:hover { background-color: #b92c2c; }
      
      /* --- Filter Buttons --- */
      #approval-filter-nav {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .filter-button {
        flex: 1;
        padding: 10px 15px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color-secondary);
        cursor: pointer;
        transition: all 0.2s;
      }
      .filter-button:hover {
        background-color: var(--page-bg);
      }
      .filter-button.active {
        background-color: var(--konecta-blue);
        color: white;
        border-color: var(--konecta-blue);
      }
      
      /* --- History Report & Dashboard Form Layouts --- */
      #history-report-form, #dashboard-form {
        display: flex;
        flex-wrap: wrap; 
        gap: 15px;
        align-items: flex-end;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 20px;
      }
      #history-report-form .form-group, #dashboard-form .form-group {
        flex: 1;
        min-width: 150px; 
        margin-bottom: 0;
      }
      #history-user-select, #dashboard-user-select {
        height: 120px;
      }
      #history-report-form button {
        width: auto;
        min-width: 150px;
        margin: 0 0 0 10px;
        box-shadow: none;
        transform: none;
      }
      #history-report-form .view-btn {
        background-color: var(--konecta-dark);
      }
      #history-report-form .view-btn:hover {
        background-color: #1a0199;
        transform: translateY(-1px);
      }
      #history-report-form .export-btn {
        background-color: var(--text-color-secondary);
        display: none;
      }
      #history-report-form .export-btn:hover {
        background-color: #3c4043;
      }
      
      #dashboard-filters {
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-width: 180px;
      }
      #dashboard-filters button {
        width: 100%;
        margin: 0;
      }
      #dashboard-filters .load-btn { background-color: var(--konecta-dark); }
      #dashboard-filters .load-btn:hover { background-color: #1a0199; }
      #dashboard-filters .team-btn { background-color: var(--konecta-blue); }
      #dashboard-filters .team-btn:hover { background-color: #008fbc; }
      #dashboard-filters .save-btn { background-color: #34a853; }
      #dashboard-filters .save-btn:hover { background-color: #2c8c45; }
      
      /* --- Report Tables --- */
      #history-report-display, #my-schedule-display {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
        overflow-x: auto; 
      }
      .report-table, .schedule-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }
      .report-table th, .report-table td, .schedule-table th, .schedule-table td {
        border: 1px solid var(--border-color);
        padding: 12px;
        text-align: left;
        color: var(--text-color);
      }
      .report-table th, .schedule-table th {
        background-color: var(--input-bg);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        color: var(--text-color-secondary);
      }
      
      .schedule-table .day-today {
        font-weight: 700;
        background-color: var(--konecta-yellow);
        color: black;
      }
      body.dark-mode .schedule-table .day-today {
        background-color: var(--role-admin-bg);
        color: white;
      }
      
      /* --- Dashboard Grid --- */
      #dashboard-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }
      .dashboard-card {
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }
      .dashboard-card.full-width {
        grid-column: 1 / -1;
      }
      .dashboard-card h3 {
        margin: 0 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
        color: var(--konecta-blue);
        font-size: 1.2rem;
      }
      .chart-container, .table-container {
        width: 100%;
        min-height: 250px;
        overflow-y: auto;
      }
      
      /* Dashboard Table Column Width Fix */
      #adherence-detail-table .report-table {
          table-layout: fixed;
          width: 100%;
      }
      /* Column 2 is the 'User' name (after the default Google Charts Row Number column) */
      #adherence-detail-table .report-table th:nth-child(2),
      #adherence-detail-table .report-table td:nth-child(2) {
          width: 25%; /* Restricting width of the User column */
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }

      /* --- Section divider --- */
      .section-divider {
        border: 0;
        border-top: 1px solid var(--border-color);
        margin: 30px 0;
      }

      /* --- Responsive Design --- */
      @media (max-width: 900px) {
        #dashboard-grid {
          grid-template-columns: 1fr;
        }
        .dashboard-card.full-width {
          grid-column: auto;
        }
        .form-row, #history-report-form, #dashboard-form {
          flex-direction: column;
          align-items: stretch;
        }
        #history-report-form button, #dashboard-filters button {
          margin: 10px 0 0 0;
        }
        #history-report-form .form-group, #dashboard-form .form-group {
          min-width: 100%;
        }
        main {
          margin: 15px;
        }
        header {
          padding: 15px 20px;
        }
        .content-container {
          padding: 20px;
        }
        #tab-nav {
          padding-left: 20px;
        }
        .request-list-item {
            flex-direction: column;
            align-items: stretch;
        }
        .request-list-item .item-actions {
            text-align: left;
            margin-top: 10px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <!-- NEW: Logo wrapped in container for border/shadow effect -->
      <div id="logo-container">
        <img id="konecta-logo" 
             src="https://www.theinnovationgroup.it/wp-content/uploads/2025/02/180225_LogoKonecta_425x200.jpg" 
             alt="Konecta Logo">
      </div>
      <div class="header-controls">
        <!-- Dark Mode Toggle: Uses Sun for Light and Moon for Dark -->
        <button id="dark-mode-button" title="Toggle Dark Mode" onclick="toggleDarkMode()">
           <!-- Icon source remains correct for Sun/Moon toggle -->
          <img id="dark-mode-icon" src="https://downloadr2.apkmirror.com/wp-content/uploads/2019/10/5db102cb08750-384x384.png" alt="Theme Icon">
        </button>
        <!-- Header Refresh Button -->
        <button id="header-refresh-button" title="Refresh Data" onclick="refreshCurrentData()">
          <!-- Icon source remains correct for Refresh icon -->
          <img id="refresh-icon" src="https://cdn-icons-png.flaticon.com/512/560/560512.png" alt="Refresh Icon">
        </button>
      </div>
    </header>

    <main>
      <div id="tab-nav">
        <button id="dashboard-tab-button" class="tab-button" onclick="showTab('dashboard')">Dashboard</button>
        <button id="punch-tab-button" class="tab-button active" onclick="showTab('punch')">Punch Clock</button>
        <button id="my-schedule-tab-button" class="tab-button" onclick="showTab('my-schedule')">My Schedule</button>
        <button id="leave-request-tab-button" class="tab-button" onclick="showTab('leave-request')">My Leave</button> 
        <button id="leave-approval-tab-button" class="tab-button" onclick="showTab('leave-approval')">Approvals</button>
        <button id="history-report-tab-button" class="tab-button" onclick="showTab('history-report')">History Report</button>
        <button id="schedule-tab-button" class="tab-button" onclick="showTab('schedule')">Schedule Editor</button>
        <button id="admin-tools-tab-button" class="tab-button" onclick="showTab('admin-tools')">Admin Tools</button>
        <button id="reporting-line-tab-button" class="tab-button" onclick="showTab('reporting-line')">Reporting Line</button>
      </div>

      <div class="content-container">

        <!-- ================================== -->
        <!--      TAB 1: PUNCH PANEL            -->
        <!-- ================================== -->
        <div id="punch-panel" class="tab-panel">
          <div id="agent-info">Loading user info...</div> 
          <div id="admin-panel"><label for="agent-select">Punch For:</label><select id="agent-select"></select></div>
          <div id="buttons">
            <div class="button-group"><button onclick="punch('Login')">Login</button></div>
            <div class="button-group"><button onclick="punch('First Break In')">1st Break In</button><button onclick="punch('First Break Out')">1st Break Out</button></div>
            <div class="button-group"><button onclick="punch('Lunch In')">Lunch In</button><button onclick="punch('Lunch Out')">Lunch Out</button></div>
            <div class="button-group"><button onclick="punch('Last Break In')">Last Break In</button><button onclick="punch('Last Break Out')">Last Break Out</button></div>
            <div class="button-group"><button onclick="punch('Logout')">Logout</button></div>
          </div>
          <div id="other-buttons">
             <div class="button-group"><button onclick="punch('Coaching In')">Coaching In</button><button onclick="punch('Coaching Out')">Coaching Out</button></div>
            <div class="button-group"><button onclick="punch('Meeting In')">Meeting In</button><button onclick="punch('Meeting Out')">Meeting Out</button></div>
             <div class="button-group"><button onclick="punch('Personal In')">Personal In</button><button onclick="punch('Personal Out')">Personal Out</button></div>
          </div>
          <div id="status" class="status-message"></div>
        </div>

        <!-- ================================== -->
        <!--      TAB 2: MY SCHEDULE PANEL      -->
        <!-- ================================== -->
        <div id="my-schedule-panel" class="tab-panel">
          <h2>My Upcoming Schedule</h2>
          <p>Your schedule for the next 7 days.</p>
          <div id="my-schedule-status" class="status-message"></div>
          <div id="my-schedule-display"></div>
        </div>

        <!-- ================================== -->
        <!--     TAB 3: MY LEAVE PANEL          -->
        <!-- ================================== -->
        <div id="leave-request-panel" class="tab-panel">
          <h2>My Balances</h2>
          <div id="leave-balances">
            <div class="balance-item"><p>Annual</p><span class="balance-days" id="balance-annual">--</span></div>
            <div class="balance-item"><p>Sick</p><span class="balance-days" id="balance-sick">--</span></div>
            <div class="balance-item"><p>Casual</p><span class="balance-days" id="balance-casual">--</span></div>
          </div>
          <form id="leave-form" class="form-container">
            <h2>Submit Leave Request</h2>
            <div class="form-group"><label for="leave-type">Leave Type</label><select id="leave-type"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Casual">Casual</option></select></div>
            <div class="form-row">
              <div class="form-group"><label for="leave-start-date">Start Date</label><input type="date" id="leave-start-date" required></div>
              <div class="form-group"><label for="leave-end-date">End Date</label><input type="date" id="leave-end-date"><small>Leave blank for a single-day request.</small></div>
            </div>
            <div class="form-group"><label for="leave-reason">Reason (Optional)</label><textarea id="leave-reason" rows="3"></textarea></div>
            <button type="button" class="submit-btn-green" onclick="submitLeaveRequest()">Submit Request</button>
          </form>
          <div id="leave-status" class="status-message"></div>
          <div class="request-list">
            <h2>My Request History</h2>
            <div id="my-requests-list" class="request-list"></div>
          </div>
        </div>
        
        <!-- ================================== -->
        <!--    TAB 4: HISTORY REPORT PANEL     -->
        <!-- ================================== -->
        <div id="history-report-panel" class="tab-panel">
          <h2>Adherence History Report</h2>
          <form id="history-report-form" class="form-container">
            <div class="form-group" id="history-user-select-group" style="display: none;">
              <label for="history-user-select">Select User(s) (Ctrl+Click)</label>
              <select id="history-user-select" multiple></select>
            </div>
            <div class="form-group">
              <label for="history-start-date">Start Date</label>
              <input type="date" id="history-start-date" required>
            </div>
            <div class="form-group">
              <label for="history-end-date">End Date</label>
              <input type="date" id="history-end-date" required>
            </div>
            <button type="button" class="view-btn" onclick="loadHistoryReport()">View History</button>
            <button type="button" class="export-btn" id="export-csv-btn" onclick="exportHistoryToCSV()">Export to CSV</button>
          </form>
          
          <div id="my-history-status" class="status-message"></div>
          <div id="history-report-display">
             <p class="text-color-secondary">Select users and dates, then click "View History" to generate the report.</p>
          </div>
        </div>

        <!-- ================================== -->
        <!--    TAB 5: SCHEDULE EDITOR PANEL    -->
        <!-- ================================== -->
        <div id="schedule-panel" class="tab-panel">
          <form id="csv-import-form" class="form-container">
            <h2>Bulk Schedule Importer (CSV)</h2>
            <p class="text-color-secondary">Upload a CSV file with headers: `Name`, `Date` (MM/dd/yyyy), `StartTime` (HH:mm), `EndTime` (HH:mm), `LeaveType`, `Email`</p>
            <div class="form-group">
              <label for="csv-file-input">Select CSV File</label>
              <input type="file" id="csv-file-input" accept=".csv">
            </div>
            <button type="button" style="background-color:var(--konecta-dark)" onclick="importScheduleCSV()">Import CSV</button>
          </form>
          <div id="csv-import-status" class="status-message"></div>
          
          <hr class="section-divider">
          
          <form id="schedule-form" class="form-container">
            <h2>Manual Schedule Editor</h2>
            <div class="form-group"><label for="schedule-agent-select">User</label><select id="schedule-agent-select"></select></div>
            <div class="form-row">
              <div class="form-group"><label for="schedule-start-date">Start Date</label><input type="date" id="schedule-start-date" required></div>
              <div class="form-group"><label for="schedule-end-date">End Date (Optional)</label><input type="date" id="schedule-end-date"><small>Leave blank to submit for a single day.</small></div>
            </div>
            <div class="form-group"><label for="schedule-leave-type">Leave Type / Status</label><select id="schedule-leave-type" onchange="toggleTimeFields()"><option value="Present">Present</option><option value="Sick">Sick</option><option value="Annual">Annual</option><option value="Casual">Casual</option><option value="Absent">Absent</option></select></div>
            <div id="time-fields" class="form-row">
              <div class="form-group"><label for="schedule-start-time">Shift Start Time</label><input type="time" id="schedule-start-time"></div>
              <div class="form-group"><label for="schedule-end-time">Shift End Time</label><input type="time" id="schedule-end-time"></div>
            </div>
            <button type="button" class="submit-btn-green" onclick="submitSchedule()">Submit Schedule(s)</button>
          </form>
          <div id="schedule-status" class="status-message"></div>
        </div>
        
        <!-- ================================== -->
        <!--   TAB 6: LEAVE APPROVALS PANEL     -->
        <!-- ================================== -->
        <div id="leave-approval-panel" class="tab-panel">
          <h2>Pending Leave Approvals</h2>
          <div id="approval-filter-nav">
            <button id="filter-mine" class="filter-button active" onclick="loadPendingRequests('mine')">My Pending Requests</button>
            <button id="filter-all" class="filter-button" onclick="loadPendingRequests('all')">All Pending Requests</button>
          </div>
          <div id="approval-status" class="status-message"></div>
          <div id="pending-requests-list" class="request-list"></div>
        </div>
        
        <!-- ================================== -->
        <!--     TAB 7: ADMIN TOOLS PANEL       -->
        <!-- ================================== -->
        <div id="admin-tools-panel" class="tab-panel">
          <form id="manual-punch-form" class="form-container">
            <h2>Manual Punch Editor</h2>
            <p class="text-color-secondary">Manually add or overwrite a punch for a user. This will bypass duplicate/sequential checks and recalculate metrics.</p>
            <div class="form-group"><label for="manual-punch-user">User</label><select id="manual-punch-user" required></select></div>
            <div class="form-group"><label for="manual-punch-action">Punch Action</label><select id="manual-punch-action" required><option value="">-- Select an action --</option><optgroup label="Adherence"><option value="Login">Login</option><option value="First Break In">First Break In</option><option value="First Break Out">First Break Out</option><option value="Lunch In">Lunch In</option><option value="Lunch Out">Lunch Out</option><option value="Last Break In">Last Break In</option><option value="Last Break Out">Last Break Out</option><option value="Logout">Logout</option></optgroup><optgroup label="Other Codes"><option value="Coaching In">Coaching In</option><option value="Coaching Out">Coaching Out</option><option value="Meeting In">Meeting In</option><option value="Meeting Out">Meeting Out</option><option value="Personal In">Personal In</option><option value="Personal Out">Personal Out</option></optgroup></select></div>
            <div class="form-row"><div class="form-group"><label for="manual-punch-date">Date of Punch</label><input type="date" id="manual-punch-date" required></div><div class="form-group"><label for="manual-punch-time">Time of Punch</label><input type="time" id="manual-punch-time" required></div></div>
            <button type="button" onclick="submitManualPunch()" style="background-color:var(--konecta-dark)">Submit Manual Punch</button>
          </form>
          <div id="manual-punch-status" class="status-message"></div>
          
          <hr class="section-divider">
          
           <form id="balance-adjustment-form" class="form-container">
            <h2>Leave Balance Management</h2>
            <p class="text-color-secondary">Manually adjust a user's leave balance. Use a positive number (e.g., 2) to add days, and a negative number (e.g., -1) to remove days.</p>
            <div class="form-group"><label for="balance-user-select">Select User</label><select id="balance-user-select" required></select></div>
            <div class="form-row">
              <div class="form-group"><label for="balance-leave-type">Leave Type</label><select id="balance-leave-type"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Casual">Casual</option></select></div>
              <div class="form-group"><label for="balance-amount">Amount to Adjust</label><input type="number" id="balance-amount" step="0.5" placeholder="e.g., -1 or 1.5" required></div>
            </div>
            <div class="form-group"><label for="balance-reason">Reason for Adjustment</label><textarea id="balance-reason" rows="2" required></textarea></div>
            <button type="button" style="background-color:var(--konecta-yellow); color:black;" onclick="submitBalanceAdjustment()">Submit Balance Adjustment</button>
          </form>
          <div id="balance-adjust-status" class="status-message"></div>

          <hr class="section-divider">
          
          <form id="admin-leave-form" class="form-container">
            <h2>Submit Leave on Behalf of User</h2>
            <p class="text-color-secondary">Submit a leave request for a user. This will check their balance and send it to their assigned supervisor for approval.</p>
            <div class="form-group"><label for="admin-leave-user">Select User</LabeL><select id="admin-leave-user" required></select></div>
            <div class="form-group"><label for="admin-leave-type">Leave Type</label><select id="admin-leave-type"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Casual">Casual</option></select></div>
            <div class="form-row"><div class="form-group"><label for="admin-leave-start-date">Start Date</label><input type="date" id="admin-leave-start-date" required></div><div class="form-group"><label for="admin-leave-end-date">End Date</label><input type="date" id="admin-leave-end-date"><small>Leave blank for a single-day request.</small></div></div>
            <div class="form-group"><label for="admin-leave-reason">Reason (Optional)</label><textarea id="admin-leave-reason" rows="3"></textarea></div>
            <button type="button" class="submit-btn-green" onclick="submitAdminLeaveRequest()">Submit Request for User</button>
          </form>
          
          <div id="admin-leave-status" class="status-message"></div>
        </div>

        <!-- ================================== -->
        <!--     TAB 8: DASHBOARD PANEL         -->
        <!-- ================================== -->
        <div id="dashboard-panel" class="tab-panel">
          <h2 id="dashboard-title">Team Dashboard</h2>
          <div id="dashboard-controls" class="form-container">
            <form id="dashboard-form">
              <div class="form-group">
                <label for="dashboard-user-select">Select Users (Ctrl+Click)</label>
                <select id="dashboard-user-select" multiple></select>
              </div>
              <div class="form-group">
                <label for="dashboard-date">Select Date</label>
                <input type="date" id="dashboard-date" required>
              </div>
              <div id="dashboard-filters">
                <button type="button" class="load-btn" onclick="loadDashboard()">Load Dashboard</button>
                <button type="button" class="team-btn" onclick="loadMyTeam(false)">Load My Team</button>
                <button type="button" class="save-btn" onclick="saveMyTeam()">Save as My Team</button>
              </div>
            </form>
          </div>
          <div id="dashboard-status" class="status-message"></div>
          
          <hr class="section-divider">
          
          <div id="dashboard-grid">
            <div class="dashboard-card">
              <h3>Current User Status</h3>
              <div id="status-pie-chart" class="chart-container"></div>
            </div>
            <div class="dashboard-card">
              <h3>Total Adherence Metrics</h3>
              <div id="adherence-bar-chart" class="chart-container"></div>
            </div>
            <div class="dashboard-card full-width">
              <h3>Adherence Details</h3>
              <div id="adherence-detail-table" class="table-container"></div>
            </div>
            <div class="dashboard-card full-width">
              <h3>Pending Leave Requests (for selected users)</h3>
              <div id="pending-leave-table" class="chart-container"></div>
            </div>
          </div>
        </div>
        
        <!-- ================================== -->
        <!--    NEW TAB 9: REPORTING LINE       -->
        <!-- ================================== -->
        <div id="reporting-line-panel" class="tab-panel">
          <form id="reporting-line-form" class="form-container">
            <h2>Update User Reporting Line</h2>
            <p class="text-color-secondary">Select a user and assign them to a new supervisor. This action is typically only possible if you are a Superadmin, or if the user and new supervisor are both under your management.</p>
            
            <div class="form-group">
              <label for="reporting-line-user">Select User to Move</label>
              <select id="reporting-line-user" required></select>
            </div>
            
            <div class="form-group">
              <label for="reporting-line-supervisor">Assign to New Supervisor</label>
              <select id="reporting-line-supervisor" required></select>
            </div>
            
            <button type="button" onclick="submitReportingLineChange()" style="background-color:var(--konecta-dark)">Update Reporting Line</button>
          </form>
          <div id="reporting-line-status" class="status-message"></div>
        </div>

      </div> <!-- End .content-container -->
    </main> <!-- End .card -->

    <footer>
      <p style="color:var(--text-color-secondary)">Konecta Adherence Portal - Created by Fady Bekhet</p>
    </footer>


    <script>
      let selfUserName = ""; 
      let selfRole = "agent"; 
      let allUsersList = []; 
      let allAdminsList = []; 
      let lastHistoryData = null;
      let chartsLoaded = false; 
      
      // --- NEW: Dark Mode Functions ---
      const DARK_MODE_KEY = 'kap_dark_mode';
      
      // Icon sources
      const SUN_ICON = "https://www.svgrepo.com/show/396652/sun.svg";
      const MOON_ICON = "https://www.svgrepo.com/show/532395/moon.svg";
      const REFRESH_ICON = "https://icons.veryicon.com/png/o/miscellaneous/two-color-webpage-small-icon/refresh-174.png";

      function applyTheme(isDark) {
        const body = document.body;
        const icon = document.getElementById('dark-mode-icon');
        const allIcons = document.querySelectorAll('#header-refresh-button img, #dark-mode-button img');
        
        if (isDark) {
          body.classList.add('dark-mode');
          body.setAttribute('data-theme', 'dark');
          if (icon) icon.src = MOON_ICON; // Update icon to MOON
          
          // Invert all non-theme icons in dark mode
          allIcons.forEach(img => {
            if (img.id !== 'dark-mode-icon') {
              img.style.filter = 'invert(100%)';
            }
          });
          // Refresh icon needs to be forced to 'none' if it's the specific PNG which is already color-appropriate
          document.getElementById('refresh-icon').style.filter = 'none'; 

        } else {
          body.classList.remove('dark-mode');
          body.setAttribute('data-theme', 'light');
          if (icon) icon.src = SUN_ICON; // Update icon to SUN
          
          allIcons.forEach(img => {
             img.style.filter = 'none';
          });
        }
      }

      function toggleDarkMode() {
        const isDark = document.body.classList.contains('dark-mode');
        const newTheme = !isDark;
        applyTheme(newTheme);
        localStorage.setItem(DARK_MODE_KEY, newTheme ? 'enabled' : 'disabled');
      }

      function initializeTheme() {
        const savedTheme = localStorage.getItem(DARK_MODE_KEY);
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        let initialTheme = prefersDark;

        if (savedTheme === 'enabled') {
            initialTheme = true;
        } else if (savedTheme === 'disabled') {
            initialTheme = false;
        }
        
        applyTheme(initialTheme);
      }
      
      // --- Status Message Utility ---
      function setStatus(id, type, message) {
        const statusDiv = document.getElementById(id);
        
        // Hide all statuses first (removes visible class)
        document.querySelectorAll('.status-message').forEach(div => {
            div.classList.remove('visible', 'success', 'error', 'processing');
        });
        
        if (message) {
            statusDiv.classList.add('visible', type);
            statusDiv.innerText = message;
        } else {
            statusDiv.classList.remove('visible', 'success', 'error', 'processing');
        }
      }
      
      // === TAB SWITCHING FUNCTION ===
      function showTab(tabName) {
        // Hide all panels
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.style.display = 'none';
        });

        // Deactivate all tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
          button.classList.remove('active');
        });
        
        // Clear all status messages
        document.querySelectorAll('.status-message').forEach(div => {
            div.classList.remove('visible', 'success', 'error', 'processing');
        });

        // Show the correct panel and activate the correct button
        document.getElementById(tabName + '-panel').style.display = 'block';
        document.getElementById(tabName + '-tab-button').classList.add('active');
        
        // Refresh data when certain tabs are clicked
        if (tabName === 'leave-approval') {
          const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
          loadPendingRequests(currentFilter);
        } else if (tabName === 'leave-request') {
          loadMyRequests();
          google.script.run.withSuccessHandler(user => {
            if(user && user.myBalances) populateMyBalances(user.myBalances);
          }).getUserInfo();
        } else if (tabName === 'my-schedule') {
          loadMySchedule();
        } 
      }
      
      // --- Refresh User Info ---
      function refreshCurrentData() {
        const btn = document.getElementById('header-refresh-button');
        btn.classList.add('loading');
        
        const activeTab = document.querySelector('.tab-button.active');
        const activeTabName = activeTab ? activeTab.id.replace('-tab-button', '') : 'punch';
        
        google.script.run
          .withSuccessHandler(user => {
            populateUserInfo(user); 
            
            // Now, reload the data for the specific tab
            if (activeTabName === 'leave-approval') {
              const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
              loadPendingRequests(currentFilter);
            } else if (activeTabName === 'leave-request') {
              loadMyRequests();
            } else if (activeTabName === 'my-schedule') {
              loadMySchedule();
            } else if (activeTabName === 'dashboard') {
              loadDashboard();
            } else if (activeTabName === 'history-report' && lastHistoryData) {
              loadHistoryReport(); 
            }
            
            setTimeout(() => {
              btn.classList.remove('loading');
            }, 500); 
          })
          .withFailureHandler(err => {
            btn.classList.remove('loading');
            const infoDiv = document.getElementById('agent-info');
            infoDiv.innerHTML = "Error refreshing data. Please try again.";
            infoDiv.classList.add('error');
          })
          .getUserInfo();
      }

      // NEW: Extracted user info population into its own function
      function populateUserInfo(user) {
        const infoDiv = document.getElementById('agent-info');
        
        if (!user || !user.name && (user.role === 'agent' || !user.email.includes("konecta.com"))) {
          infoDiv.innerHTML = "Your email is not registered. Contact your supervisor.";
          infoDiv.className = 'error'; 
          return;
        }

        selfUserName = user.name; 
        selfRole = user.role; 
        allUsersList = user.allUsers; 
        allAdminsList = user.allAdmins; 
        
        // --- Apply Role-Based Body Class ---
        document.body.setAttribute('data-role', user.role);

        let displayRole = user.role.charAt(0).toUpperCase() + user.role.slice(1);
        
        infoDiv.innerHTML = `<strong>User:</strong> ${user.name || 'ADMIN'} &nbsp;|&nbsp; <strong>Email:</strong> ${user.email} &nbsp;|&nbsp; <strong>Role:</strong> ${displayRole}`; 
        infoDiv.className = '';
        
        document.getElementById('buttons').style.display = 'block';
        document.getElementById('other-buttons').style.display = 'block';
        document.getElementById('my-schedule-tab-button').style.display = 'inline-block';
        
        if (user.myBalances) populateMyBalances(user.myBalances);

        // --- Show/Hide Tabs Based on Role ---
        if (user.role === 'admin' || user.role === 'superadmin') {
          document.getElementById('dashboard-tab-button').style.display = 'inline-block';
          document.getElementById('schedule-tab-button').style.display = 'inline-block';
          document.getElementById('leave-approval-tab-button').style.display = 'inline-block';
          document.getElementById('admin-tools-tab-button').style.display = 'inline-block'; 
          document.getElementById('history-report-tab-button').style.display = 'inline-block'; 
          document.getElementById('history-user-select-group').style.display = 'block'; 
          document.getElementById('reporting-line-tab-button').style.display = 'inline-block';
          
          populateAdminDropdown(allUsersList, selfUserName, 'agent-select', 'Punch for: Myself');
          document.getElementById('admin-panel').style.display = 'block';
          populateAdminDropdown(allUsersList, selfUserName, 'schedule-agent-select', 'Select a user');
          populateAdminDropdown(allUsersList, selfUserName, 'manual-punch-user', 'Select a user'); 
          populateAdminDropdown(allUsersList, selfUserName, 'admin-leave-user', 'Select user to submit for'); 
          populateAdminDropdown(allUsersList, selfUserName, 'history-user-select', 'Select a user'); 
          populateAdminDropdown(allUsersList, selfUserName, 'balance-user-select', 'Select a user');
          populateAdminDropdown(allUsersList, selfUserName, 'dashboard-user-select', 'Select users'); 
          populateAdminDropdown(allUsersList, selfUserName, 'reporting-line-user', 'Select a user');
          populateSupervisorDropdown(allAdminsList, 'reporting-line-supervisor');
          
          
          if (user.role === 'superadmin') {
            loadPendingRequests('all'); 
          } else {
            loadPendingRequests('mine'); 
          }
          
        } else {
          // User is an agent
          document.getElementById('history-report-tab-button').style.display = 'inline-block'; 
          document.getElementById('history-user-select-group').style.display = 'none'; 
        }
        
        loadMyRequests();
      }

      function loadUserInfo() { 
        // 1. Check saved theme
        initializeTheme();
        
        // 2. Set timeout for failure
        const loadTimeout = setTimeout(() => {
          const infoDiv = document.getElementById('agent-info');
          infoDiv.innerHTML = "The request timed out. Please refresh and re-authorize the script if asked.";
          infoDiv.classList.add('error', 'visible');
          infoDiv.style.textAlign = 'center';
        }, 15000);

        // 3. Run script
        google.script.run
          .withSuccessHandler(user => { 
            clearTimeout(loadTimeout); 
            populateUserInfo(user);

            if (user.role === 'admin' || user.role === 'superadmin') {
              // Load saved team to pre-select dropdown (but don't load the chart yet)
              google.script.run.withSuccessHandler(teamEmails => {
                if (teamEmails && teamEmails.length > 0) {
                  const select = document.getElementById('dashboard-user-select');
                  Array.from(select.options).forEach(option => {
                    option.selected = teamEmails.includes(option.value);
                  });
                  // Auto load dashboard only if it's the first admin/superadmin view
                  // This relies on the default tab being 'punch', which it is.
                  // We can't tell if the user has navigated back, so we'll skip auto-loading for simplicity after a DOMContentLoaded event.
                }
              }).webGetMyTeam(); 
            }
          })
          .withFailureHandler(err => {
            clearTimeout(loadTimeout); 
            const infoDiv = document.getElementById('agent-info');
            let errorMsg = err.message || JSON.stringify(err);
            infoDiv.innerHTML = "Could not load user info. Error: " + errorMsg; 
            infoDiv.classList.add('error', 'visible');
        }).getUserInfo(); 
      }

      function populateAdminDropdown(users, selfName, dropdownId, selfText) { 
        const select = document.getElementById(dropdownId);
        select.innerHTML = ''; 
        
        // Create the 'Me' or 'Select a user' option
        const firstOption = document.createElement('option');
        if (dropdownId === 'agent-select') {
          const selfUser = users.find(u => u.name === selfName);
          firstOption.value = selfUser ? selfUser.email : '';
          firstOption.textContent = `${selfText} (${selfName})`;
        } else {
          firstOption.value = ""; 
          firstOption.textContent = selfText;
        }
        select.appendChild(firstOption);

        // Add all other users
        users.forEach(user => { 
          const option = document.createElement('option');
          option.value = user.email; // Use EMAIL as value
          option.textContent = `${user.name} (${user.email})`;
          select.appendChild(option);
        });
        
        // Select the 'Me' option for the punch clock default
        if (dropdownId === 'agent-select') {
          select.selectedIndex = 0;
        }
      }
      
      function populateSupervisorDropdown(admins, dropdownId = 'leave-supervisor') {
        const select = document.getElementById(dropdownId);
        select.innerHTML = '<option value="">-- Select a supervisor --</option>'; 
        
        admins.forEach(admin => {
          const option = document.createElement('option');
          option.value = admin.email; 
          option.textContent = `${admin.name}`; 
          select.appendChild(option);
        });
      }
      
      function populateMyBalances(balances) {
        if (!balances) return;
        document.getElementById('balance-annual').textContent = balances.annual;
        document.getElementById('balance-sick').textContent = balances.sick;
        document.getElementById('balance-casual').textContent = balances.casual;
      }

      function punch(action) {
        const adminSelect = document.getElementById('agent-select');
        let targetUserName = '';
        
        if (selfRole === 'admin' || selfRole === 'superadmin') {
          const selectedEmail = adminSelect.value;
          const user = allUsersList.find(u => u.email === selectedEmail);
          targetUserName = user ? user.name : '';
        } else {
          targetUserName = selfUserName;
        }
        
        if (!targetUserName) { 
           setStatus('status', 'error', 'Please select a user to punch for.');
           return;
        }

        setStatus('status', 'processing', `Processing "${action}" for ${targetUserName}...`);

        google.script.run
          .withSuccessHandler(msg => {
            if (msg.startsWith('Error:')) {
              setStatus('status', 'error', msg.replace('Error: ', ''));
            } else {
              setStatus('status', 'success', msg);
            }
          })
          .withFailureHandler(err => {
            setStatus('status', 'error', 'Unexpected error: ' + (err.message || JSON.stringify(err)));
          })
          .webPunch(action, targetUserName, null);
      }
      
      function toggleTimeFields() {
        const leaveType = document.getElementById('schedule-leave-type').value;
        const timeFields = document.getElementById('time-fields');
        if (leaveType === 'Present') {
          timeFields.style.display = 'flex';
        } else {
          timeFields.style.display = 'none';
        }
      }
      
      function submitSchedule() {
        try {
          const userEmail = document.getElementById('schedule-agent-select').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user."); 
          
          let startDate = document.getElementById('schedule-start-date').value;
          let endDate = document.getElementById('schedule-end-date').value;
          const leaveType = document.getElementById('schedule-leave-type').value;
          let startTime = document.getElementById('schedule-start-time').value;
          let endTime = document.getElementById('schedule-end-time').value;
          
          if (!startDate) throw new Error("Please select a Start Date.");
          if (!endDate) endDate = startDate;
          if (new Date(endDate) < new Date(startDate)) throw new Error("End Date cannot be before Start Date.");
          
          if (leaveType === 'Present') {
            if (!startTime || !endTime) throw new Error("Shift Start and End Time are required for 'Present' status.");
          } else {
            startTime = "";
            endTime = "";
          }
          
          setStatus('schedule-status', 'processing', `Submitting schedule for ${user.name}...`);

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) {
                setStatus('schedule-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('schedule-status', 'success', msg);
                document.getElementById('schedule-form').reset();
                document.getElementById('schedule-start-date').valueAsDate = new Date();
                toggleTimeFields();
              }
            })
            .withFailureHandler(err => {
              setStatus('schedule-status', 'error', 'Unexpected error: ' + (err.message || JSON.stringify(err)));
            })
            .webSubmitScheduleRange(user.email, user.name, startDate, endDate, startTime, endTime, leaveType); 

        } catch (err) {
          setStatus('schedule-status', 'error', err.message);
        }
      }
      
      // --- Helper to format date strings ---
      function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        return new Date(dateStr).toLocaleDateString("en-US", { 
          year: 'numeric', month: '2-digit', day: '2-digit' 
        });
      }
      
      // --- Helper to format time strings ---
      function formatTime(dateStr) {
        if (!dateStr) return '--:--';
        // Check if dateStr is a full date string or just a time part
        if (dateStr.includes('T') || dateStr.includes('-')) {
             return new Date(dateStr).toLocaleTimeString("en-US", { 
              hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false 
            });
        }
        // If it's just a time string like "09:00:00", we can't reliably format it without assuming a date.
        return dateStr;
      }
      
      // --- Helper to format seconds ---
      function formatSeconds(seconds) {
        if (typeof seconds !== 'number' || isNaN(seconds)) return '0 sec';
        if (seconds === 0) return '0 sec';
        const isNegative = seconds < 0;
        seconds = Math.abs(seconds);
        
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        
        let str = isNegative ? '-' : '';
        if (h > 0) str += `${h}h `;
        if (m > 0) str += `${m}m `;
        if (s > 0 || (h === 0 && m === 0)) str += `${s}s`;
        
        return str.trim();
      }

      function onMyRequestsFailure(error) {
        const listDiv = document.getElementById('my-requests-list');
        listDiv.innerHTML = `<p class="status-message error visible">Error loading requests: ${error.message || JSON.stringify(error)}</p>`;
      }

      function onPendingRequestsFailure(error) {
        const listDiv = document.getElementById('pending-requests-list');
        listDiv.innerHTML = `<p class="status-message error visible">Error loading requests: ${error.message || JSON.stringify(error)}</p>`;
      }

      // --- === `loadMyRequests` ---
      function loadMyRequests() {
        google.script.run
          .withSuccessHandler(populateMyRequests)
          .withFailureHandler(onMyRequestsFailure)
          .webGetMyRequests_V2();
      }
      
      // --- === `populateMyRequests` ---
      function populateMyRequests(requests) {
        const listDiv = document.getElementById('my-requests-list');
        
        if (!Array.isArray(requests)) {
          listDiv.innerHTML = `<p class="status-message error visible">Received an invalid response from server.</p>`;
          return;
        }
        
        if (requests.length === 0) {
          listDiv.innerHTML = '<p class="text-color-secondary">You have no leave requests on file.</p>';
          return;
        }
        
        let html = '';
        requests.reverse().forEach((req, index) => {
          let statusClass = '';
          if (req.status === 'Pending') statusClass = 'status-pending';
          if (req.status === 'Approved') statusClass = 'status-approved';
          if (req.status === 'Denied') statusClass = 'status-denied';
          
          html += `
            <div class="request-list-item">
              <div class="item-details">
                <h4>${req.leaveType} Request (ID: ${req.requestID.slice(-5)})</h4>
                <p>
                  <strong>Dates:</strong> ${formatDate(req.startDate)} to ${formatDate(req.endDate)}
                  (${req.totalDays} ${req.totalDays > 1 ? 'days' : 'day'})
                </p>
                <p><strong>Submitted:</strong> ${formatDate(req.requestedDate)}</p>
                ${req.reason ? `<p><strong>Reason:</strong> ${req.reason}</p>` : ''}
                <p class="supervisor-info text-color-secondary"><strong>Supervisor:</strong> ${req.supervisorName || 'N/A'}</p>
              </div>
              <div class="item-actions">
                <span class="status-badge ${statusClass}">${req.status}</span>
              </div>
            </div>
          `;
        });
        listDiv.innerHTML = html;
      }
      
      // --- Submit New Leave Request ---
      function submitLeaveRequest() {
        try {
          const leaveType = document.getElementById('leave-type').value;
          const startDate = document.getElementById('leave-start-date').value;
          let endDate = document.getElementById('leave-end-date').value;
          const reason = document.getElementById('leave-reason').value;
          
          if (!startDate) throw new Error("Please select a Start Date.");
          if (!endDate) endDate = startDate; 
          
          if (new Date(endDate) < new Date(startDate)) {
            throw new Error("End Date cannot be before Start Date.");
          }
          
          const requestObject = {
            leaveType: leaveType,
            startDate: startDate,
            endDate: endDate,
            reason: reason
          };
          
          setStatus('leave-status', 'processing', 'Submitting request...');
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                setStatus('leave-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('leave-status', 'success', msg);
                document.getElementById('leave-form').reset();
                document.getElementById('leave-start-date').valueAsDate = new Date();
                
                loadMyRequests();
                google.script.run.withSuccessHandler(user => {
                  populateMyBalances(user.myBalances);
                }).getUserInfo();
                if (selfRole === 'admin' || selfRole === 'superadmin') {
                  const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
                  loadPendingRequests(currentFilter);
                }
              }
            })
            .withFailureHandler(err => {
              setStatus('leave-status', 'error', err.message);
            })
            .webSubmitLeaveRequest(requestObject, null);
          
        } catch (err) {
          setStatus('leave-status', 'error', err.message);
        }
      }
      
      // --- === `loadPendingRequests` ---
      function loadPendingRequests(filter) {
        if (!filter) {
          filter = (selfRole === 'superadmin') ? 'all' : 'mine';
        }
      
        if (filter === 'mine') {
          document.getElementById('filter-mine').classList.add('active');
          document.getElementById('filter-all').classList.remove('active');
        } else {
          document.getElementById('filter-mine').classList.remove('active');
          document.getElementById('filter-all').classList.add('active');
        }
        
        if (selfRole === 'superadmin') {
           document.getElementById('filter-all').style.display = 'inline-block';
        } else {
           document.getElementById('filter-all').style.display = 'none';
        }
        
        google.script.run
          .withSuccessHandler(populatePendingRequests)
          .withFailureHandler(onPendingRequestsFailure)
          .webGetPendingRequests_V2(filter);
      }
      
      // --- === `populatePendingRequests` ---
      function populatePendingRequests(requests) {
        const listDiv = document.getElementById('pending-requests-list');
        
        if (!Array.isArray(requests)) {
          listDiv.innerHTML = `<p class="status-message error visible">Received an invalid response from server.</p>`;
          return;
        }

        if (!requests || requests.length === 0) {
          listDiv.innerHTML = '<p class="text-color-secondary">There are no pending leave requests in this view.</p>';
          return;
        }
        
        let html = '';
        requests.forEach((req, index) => {
          let balanceInfo = '';
          if (req.requesterBalance) {
            const balanceKey = req.leaveType.toLowerCase();
            const daysLeft = req.requesterBalance[balanceKey];
            balanceInfo = `<p class="supervisor-info text-color-secondary"><strong>Balance Check:</strong> ${daysLeft} ${req.leaveType} days remaining.</p>`;
          }
        
          html += `
            <div class="request-list-item">
              <div class="item-details">
                <h4>${req.requestedByName} - ${req.leaveType} Request (ID: ${req.requestID.slice(-5)})</h4>
                <p>
                  <strong>Dates:</strong> ${formatDate(req.startDate)} to ${formatDate(req.endDate)}
                  (${req.totalDays} ${req.totalDays > 1 ? 'days' : 'day'})
                </p>
                <p><strong>Submitted:</strong> ${formatDate(req.requestedDate)}</p>
                ${req.reason ? `<p><strong>Reason:</strong> ${req.reason}</p>` : ''}
                <p class="supervisor-info text-color-secondary"><strong>Assigned Supervisor:</strong> ${req.supervisorName || 'N/A'}</p>
                ${balanceInfo} 
              </div>
              <div class="item-actions">
                <button class="approve-btn" onclick="approveDenyRequest('${req.requestID}', 'Approved')">Approve</button>
                <button class="deny-btn" onclick="approveDenyRequest('${req.requestID}', 'Denied')">Deny</button>
              </div>
            </div>
          `;
        });
        listDiv.innerHTML = html;
      }
      
      // --- Admin Approve/Deny Function ---
      function approveDenyRequest(requestID, newStatus) {
        setStatus('approval-status', 'processing', `Processing request...`);
        
        google.script.run
          .withSuccessHandler(msg => {
            if (msg.startsWith('Error:')) { 
              setStatus('approval-status', 'error', msg.replace('Error: ', ''));
            } else {
              setStatus('approval-status', 'success', msg);
            }
            const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
            loadPendingRequests(currentFilter);
            loadMyRequests(); // Update self requests
            google.script.run.withSuccessHandler(user => {
              populateMyBalances(user.myBalances); // Update self balances
            }).getUserInfo();
          })
          .withFailureHandler(err => {
            setStatus('approval-status', 'error', err.message);
          })
          .webApproveDenyRequest(requestID, newStatus);
      }
      
      // --- Load My Schedule ---
      function loadMySchedule() {
        setStatus('my-schedule-status', 'processing', 'Loading your schedule...');
        document.getElementById('my-schedule-display').innerHTML = '';

        google.script.run
          .withSuccessHandler(populateMySchedule)
          .withFailureHandler(err => {
            setStatus('my-schedule-status', 'error', err.message);
          })
          .webGetMySchedule();
      }

      // --- Populate My Schedule ---
      function populateMySchedule(scheduleData) {
        const displayDiv = document.getElementById('my-schedule-display');
        
        if (scheduleData.error) {
          setStatus('my-schedule-status', 'error', scheduleData.error);
          return;
        }
        
        if (scheduleData.length === 0) {
          setStatus('my-schedule-status', 'success', 'No schedule found for the next 7 days.');
          return;
        }

        setStatus('my-schedule-status', 'success', ''); // Clear status

        let html = `
          <table class="schedule-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Day</th>
                <th>Status</th>
                <th>Shift Start</th>
                <th>Shift End</th>
              </tr>
            </thead>
            <tbody>
        `;

        const today = new Date();
        today.setHours(0,0,0,0);

        scheduleData.forEach(day => {
          const scheduleDate = new Date(day.date);
          const dayStr = scheduleDate.toLocaleDateString('en-US', { weekday: 'long' });
          const dateStr = formatDate(day.date);
          
          let trClass = '';
          if (scheduleDate.getTime() < today.getTime()) {
            trClass = 'day-past';
          } else if (scheduleDate.getTime() === today.getTime()) {
            trClass = 'day-today';
          }

          let statusClass = '';
          if (day.leaveType !== 'Present') {
            statusClass = 'status-leave';
          }

          html += `
            <tr class="${trClass}">
              <td>${dateStr}</td>
              <td>${dayStr}</td>
              <td class="${statusClass}">${day.leaveType}</td>
              <td>${day.startTime || '--:--'}</td>
              <td>${day.endTime || '--:--'}</td>
            </tr>
          `;
        });

        html += '</tbody></table>';
        displayDiv.innerHTML = html;
      }
      
      // --- Load History Report ---
      function loadHistoryReport() {
        const startDate = document.getElementById('history-start-date').value;
        const endDate = document.getElementById('history-end-date').value;
        
        let targetUserNames = [];
        
        if (selfRole === 'admin' || selfRole === 'superadmin') {
          const selectedOptions = document.getElementById('history-user-select').selectedOptions;
          if (selectedOptions.length === 0) {
            setStatus('my-history-status', 'error', 'Please select at least one user to view.');
            return;
          }
          for (let option of selectedOptions) {
            const user = allUsersList.find(u => u.email === option.value);
            if (user) targetUserNames.push(user.name);
          }
        } else {
          targetUserNames.push(selfUserName);
        }
        
        if (!startDate || !endDate) {
          setStatus('my-history-status', 'error', 'Please select a Start and End date to view.');
          return;
        }
        if (new Date(endDate) < new Date(startDate)) {
          setStatus('my-history-status', 'error', 'End Date cannot be before Start Date.');
          return;
        }
        
        setStatus('my-history-status', 'processing', `Loading history for ${targetUserNames.length} user(s)...`);
        document.getElementById('history-report-display').innerHTML = '';
        lastHistoryData = null;
        document.getElementById('export-csv-btn').style.display = 'none';
        
        google.script.run
          .withSuccessHandler(data => {
            if (data.error) {
              setStatus('my-history-status', 'error', data.error);
              return;
            }
            
            setStatus('my-history-status', 'success', `Displaying ${data.length} record(s).`);
            populateHistoryReport(data);
            lastHistoryData = data;
            document.getElementById('export-csv-btn').style.display = 'inline-block';
          })
          .withFailureHandler(err => {
            setStatus('my-history-status', 'error', err.message);
          })
          .webGetAdherenceRange(targetUserNames, startDate, endDate);
      }
      
      // --- Populate History Report Table ---
      function populateHistoryReport(data) {
        const displayDiv = document.getElementById('history-report-display');
        
        if (!data || data.length === 0) {
          displayDiv.innerHTML = '<p class="text-color-secondary">No adherence records found for the selected criteria.</p>';
          return;
        }

        const formatExceed = (value, isPositive) => {
          if (!value || value === 'No' || value === 0) return '0';
          const seconds = parseInt(value, 10);
          if (seconds > 0) {
              const color = isPositive ? 'var(--google-green)' : '#ea4335';
              return `<span style="font-weight: 600; color: ${color};">${formatSeconds(seconds)}</span>`;
          }
          return '0';
        };

        let html = `
          <table class="report-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Date</th>
                <th>Status</th>
                <th>Login</th>
                <th>Logout</th>
                <th>Tardy</th>
                <th>Early Leave</th>
                <th>Overtime</th>
                <th>Break Exceed</th>
                <th>Lunch Exceed</th>
              </tr>
            </thead>
            <tbody>
        `;

        data.forEach(row => {
          const totalBreakExceed = (parseInt(row.firstBreakExceed, 10) || 0) + (parseInt(row.lastBreakExceed, 10) || 0);
          
          html += `
            <tr>
              <td>${row.userName}</td>
              <td>${formatDate(row.date)}</td>
              <td>${row.leaveType || 'N/A'}</td>
              <td>${formatTime(row.login)}</td>
              <td>${formatTime(row.logout)}</td>
              <td>${formatExceed(row.tardy, false)}</td>
              <td>${formatExceed(row.earlyLeave, false)}</td>
              <td>${formatExceed(row.overtime, true)}</td>
              <td>${formatExceed(totalBreakExceed, false)}</td>
              <td>${formatExceed(row.lunchExceed, false)}</td>
            </tr>
          `;
        });

        html += '</tbody></table>';
        displayDiv.innerHTML = html;
      }
      
      // --- Export to CSV ---
      function exportHistoryToCSV() {
        if (!lastHistoryData || lastHistoryData.length === 0) {
          // Use alert() for this specific case as a fallback, but a modal would be preferred.
          // Using a simple notification here instead of alert().
          setStatus('my-history-status', 'error', "No data to export. Please 'View History' first.");
          return;
        }
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "User,Date,Status,Login,Logout,Tardy (sec),Early Leave (sec),Overtime (sec),1st Break Exceed (sec),Lunch Exceed (sec),Last Break Exceed (sec)\r\n";
        
        lastHistoryData.forEach(data => {
          let row = [
            `"${data.userName}"`,
            `"${formatDate(data.date)}"`,
            `"${data.leaveType || 'N/A'}"`,
            `"${formatTime(data.login)}"`,
            `"${formatTime(data.logout)}"`,
            data.tardy || 0,
            data.earlyLeave || 0,
            data.overtime || 0,
            data.firstBreakExceed || 0,
            data.lunchExceed || 0,
            data.lastBreakExceed || 0
          ].join(",");
          csvContent += row + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `History_Report_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link); 
        link.click();
        document.body.removeChild(link);
      }
      
      // --- Submit Manual Punch ---
      function submitManualPunch() {
        try {
          const userEmail = document.getElementById('manual-punch-user').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user.");

          const action = document.getElementById('manual-punch-action').value;
          const date = document.getElementById('manual-punch-date').value;
          const time = document.getElementById('manual-punch-time').value;
          
          if (!action) throw new Error("Please select a punch action.");
          if (!date) throw new Error("Please select a date.");
          if (!time) throw new Error("Please select a time.");
          
          const timestamp = new Date(date + 'T' + time).toISOString();
          
          setStatus('manual-punch-status', 'processing', `Processing "${action}" for ${user.name}...`);
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) {
                setStatus('manual-punch-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('manual-punch-status', 'success', msg);
                document.getElementById('manual-punch-form').reset();
                document.getElementById('manual-punch-date').valueAsDate = new Date();
                document.getElementById('manual-punch-user').selectedIndex = 0;
                document.getElementById('manual-punch-action').selectedIndex = 0;
              }
            })
            .withFailureHandler(err => {
              setStatus('manual-punch-status', 'error', err.message);
            })
            .webPunch(action, user.name, timestamp); 
            
        } catch(err) {
          setStatus('manual-punch-status', 'error', err.message);
        }
      }
      
      // --- Submit Admin Leave Request ---
      function submitAdminLeaveRequest() {
        try {
          const userEmail = document.getElementById('admin-leave-user').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user.");
          
          const leaveType = document.getElementById('admin-leave-type').value;
          const startDate = document.getElementById('admin-leave-start-date').value;
          let endDate = document.getElementById('admin-leave-end-date').value;
          const reason = document.getElementById('admin-leave-reason').value;

          if (!startDate) throw new Error("Please select a Start Date.");
          if (!endDate) endDate = startDate; 
          
          if (new Date(endDate) < new Date(startDate)) {
            throw new Error("End Date cannot be before Start Date.");
          }
          
          const requestObject = {
            leaveType: leaveType,
            startDate: startDate,
            endDate: endDate,
            reason: reason
          };
          
          setStatus('admin-leave-status', 'processing', `Submitting request for ${user.name}...`);
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                setStatus('admin-leave-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('admin-leave-status', 'success', msg);
                document.getElementById('admin-leave-form').reset();
                document.getElementById('admin-leave-start-date').valueAsDate = new Date();
                
                const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
                loadPendingRequests(currentFilter);
              }
            })
            .withFailureHandler(err => {
              setStatus('admin-leave-status', 'error', err.message);
            })
            .webSubmitLeaveRequest(requestObject, user.email);
          
        } catch (err) {
          setStatus('admin-leave-status', 'error', err.message);
        }
      }
      
      // --- Submit Balance Adjustment ---
      function submitBalanceAdjustment() {
        try {
          const userEmail = document.getElementById('balance-user-select').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user.");
          
          const leaveType = document.getElementById('balance-leave-type').value;
          const amount = parseFloat(document.getElementById('balance-amount').value);
          const reason = document.getElementById('balance-reason').value;

          if (isNaN(amount) || amount === 0) throw new Error("Please enter a valid, non-zero amount.");
          if (!reason) throw new Error("A reason is required for all adjustments.");

          setStatus('balance-adjust-status', 'processing', `Adjusting ${leaveType} balance for ${user.name}...`);

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                setStatus('balance-adjust-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('balance-adjust-status', 'success', msg);
                document.getElementById('balance-adjustment-form').reset();
              }
            })
            .withFailureHandler(err => {
              setStatus('balance-adjust-status', 'error', err.message);
            })
            .webAdjustLeaveBalance(user.email, leaveType, amount, reason);

        } catch (err) {
          setStatus('balance-adjust-status', 'error', err.message);
        }
      }
      
      // --- Import Schedule CSV ---
      function importScheduleCSV() {
        const fileInput = document.getElementById('csv-file-input');
        const file = fileInput.files[0];

        if (!file) {
          setStatus('csv-import-status', 'error', 'Please select a CSV file to import.');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const text = e.target.result;
          const data = parseCSV(text);
          
          if (!data || data.length === 0) {
            setStatus('csv-import-status', 'error', 'File is empty or invalid. Could not parse any rows.');
            return;
          }

          const headers = data[0];
          if (!headers.Name || !headers.Date || !headers.Email) {
            setStatus('csv-import-status', 'error', 'Invalid CSV format. Must include headers: Name, Date, Email. (StartTime, EndTime, LeaveType are optional)');
            return;
          }

          setStatus('csv-import-status', 'processing', `Importing ${data.length} schedule records...`);

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                setStatus('csv-import-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('csv-import-status', 'success', msg);
                fileInput.value = '';
              }
            })
            .withFailureHandler(err => {
              setStatus('csv-import-status', 'error', err.message);
            })
            .webImportScheduleCSV(data);
        };
        
        reader.onerror = function(e) {
          setStatus('csv-import-status', 'error', 'Error reading file: ' + e.message);
        };

        reader.readAsText(file);
      }

      // --- Simple CSV Parser ---
      function parseCSV(csvText) {
        const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
        if (lines.length < 2) return [];

        const headers = lines[0].split(',').map(h => h.trim());
        const result = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim());
          const obj = {};
          for (let j = 0; j < headers.length; j++) {
            obj[headers[j]] = values[j] || '';
          }
          result.push(obj);
        }
        return result;
      }

      // --- Dashboard Functions ---
      function getSelectedDashboardUsers() {
        const select = document.getElementById('dashboard-user-select');
        const selectedUsers = Array.from(select.selectedOptions).map(opt => opt.value);
        if (selectedUsers.length === 0) {
          return ['ALL_USERS'];
        }
        return selectedUsers;
      }

      function loadDashboard() {
        if (!chartsLoaded) {
          google.charts.setOnLoadCallback(loadDashboard);
          return;
        }
        const userEmails = getSelectedDashboardUsers();
        const date = document.getElementById('dashboard-date').value;
        
        if (!date) {
           setStatus('dashboard-status', 'error', 'Please select a date for the dashboard.');
           return;
        }
        
        if (userEmails.length === 1 && userEmails[0] === 'ALL_USERS') {
           document.getElementById('dashboard-title').innerText = `Full Team Dashboard for ${formatDate(date)}`;
        } else {
           document.getElementById('dashboard-title').innerText = `Dashboard for ${userEmails.length} User(s) (${formatDate(date)})`;
        }
        
        setStatus('dashboard-status', 'processing', 'Loading dashboard data...');
        
        google.script.run
          .withSuccessHandler(drawDashboard)
          .withFailureHandler(err => {
            setStatus('dashboard-status', 'error', err.message);
          })
          .webGetDashboardData(userEmails, date);
      }
      
      function drawDashboard(data) {
        if (!data || data.error) {
          setStatus('dashboard-status', 'error', data.error || 'Failed to load dashboard data.');
          document.getElementById('status-pie-chart').innerHTML = '';
          document.getElementById('adherence-bar-chart').innerHTML = '';
          document.getElementById('pending-leave-table').innerHTML = '';
          document.getElementById('adherence-detail-table').innerHTML = '';
          return;
        }
        
        setStatus('dashboard-status', 'success', 'Dashboard loaded successfully.');
        
        // 1. Draw Status Pie Chart
        const statusData = new google.visualization.DataTable();
        statusData.addColumn('string', 'Status');
        statusData.addColumn('number', 'Count');
        statusData.addRows(data.statusCounts);
        const pieOptions = { 
          title: 'Current User Status', 
          pieHole: 0.4, 
          legend: { position: 'bottom' },
          backgroundColor: 'transparent',
          titleTextStyle: { color: document.body.classList.contains('dark-mode') ? '#f4f7f6' : '#2101cd' },
          legendTextStyle: { color: document.body.classList.contains('dark-mode') ? '#b0b0b0' : '#5f6368' }
        };
        const pieChart = new google.visualization.PieChart(document.getElementById('status-pie-chart'));
        pieChart.draw(statusData, pieOptions);

        // 2. Draw Adherence Bar Chart
        const adherenceData = new google.visualization.DataTable();
        adherenceData.addColumn('string', 'Metric');
        adherenceData.addColumn('number', 'Minutes');
        adherenceData.addRows([
          ['Tardy', data.totalAdherenceMetrics.totalTardy / 60],
          ['Early Leave', data.totalAdherenceMetrics.totalEarlyLeave / 60],
          ['Break Exceed', data.totalAdherenceMetrics.totalBreakExceed / 60],
          ['Lunch Exceed', data.totalAdherenceMetrics.totalLunchExceed / 60]
        ]);
        const barOptions = {
          title: 'Total Adherence Deviations (in Minutes)',
          legend: { position: 'none' },
          backgroundColor: 'transparent',
          titleTextStyle: { color: document.body.classList.contains('dark-mode') ? '#f4f7f6' : '#2101cd' },
          vAxis: { 
            title: 'Minutes', 
            titleTextStyle: { color: document.body.classList.contains('dark-mode') ? '#b0b0b0' : '#5f6368' },
            textStyle: { color: document.body.classList.contains('dark-mode') ? '#b0b0b0' : '#5f6368' },
            gridlines: { color: document.body.classList.contains('dark-mode') ? '#444' : '#e0e0e0' }
          },
          hAxis: {
            textStyle: { color: document.body.classList.contains('dark-mode') ? '#b0b0b0' : '#5f6368' }
          }
        };
        const barChart = new google.visualization.BarChart(document.getElementById('adherence-bar-chart'));
        barChart.draw(adherenceData, barOptions);
        
        // 3. Draw Adherence Detail Table
        const detailTableData = new google.visualization.DataTable();
        detailTableData.addColumn('string', 'User');
        detailTableData.addColumn('string', 'Tardy');
        detailTableData.addColumn('string', 'Early Leave');
        detailTableData.addColumn('string', 'Overtime');
        detailTableData.addColumn('string', 'Break Exceed');
        detailTableData.addColumn('string', 'Lunch Exceed');
        detailTableData.addRows(data.individualAdherenceMetrics.map(user => {
          return [
            user.name,
            formatSeconds(user.tardy),
            formatSeconds(user.earlyLeave),
            formatSeconds(user.overtime),
            formatSeconds(user.breakExceed),
            formatSeconds(user.lunchExceed)
          ];
        }));
        const detailTableOptions = { 
          showRowNumber: true, 
          width: '100%', 
          height: '100%', 
          allowHtml: true, 
          cssClassNames: { 
            headerRow: 'report-table th', 
            tableRow: 'report-table tr', 
            oddTableRow: 'report-table tr',
            selectedTableRow: 'report-table tr',
            hoverTableRow: 'report-table tr:hover',
            tableCell: 'report-table td', 
            headerCell: 'report-table th' 
          } 
        };
        const detailTable = new google.visualization.Table(document.getElementById('adherence-detail-table'));
        detailTable.draw(detailTableData, detailTableOptions);


        // 4. Draw Pending Leave Table
        const tableData = new google.visualization.DataTable();
        tableData.addColumn('string', 'Agent');
        tableData.addColumn('string', 'Type');
        tableData.addColumn('string', 'Start Date');
        tableData.addColumn('number', 'Days');
        tableData.addRows(data.pendingRequests.map(req => {
          return [req.name, req.type, formatDate(req.startDate), req.days];
        }));
        const tableOptions = { 
          title: 'Pending Leave', 
          showRowNumber: true, 
          width: '100%', 
          height: '100%',
          backgroundColor: 'transparent',
          titleTextStyle: { color: document.body.classList.contains('dark-mode') ? '#f4f7f6' : '#2101cd' },
        };
        const table = new google.visualization.Table(document.getElementById('pending-leave-table'));
        table.draw(tableData, tableOptions);
      }
      
      function saveMyTeam() {
        const select = document.getElementById('dashboard-user-select');
        const selectedUsers = Array.from(select.selectedOptions).map(opt => opt.value);
        
        if (selectedUsers.length === 0) {
          setStatus('dashboard-status', 'error', 'Please select at least one user to save as your team.');
          return;
        }
        
        setStatus('dashboard-status', 'processing', 'Saving "My Team"...');
        
        google.script.run
          .withSuccessHandler(msg => {
            setStatus('dashboard-status', 'success', msg);
          })
          .withFailureHandler(err => {
            setStatus('dashboard-status', 'error', err.message);
          })
          .webSaveMyTeam(selectedUsers);
      }
      
      function loadMyTeam(autoLoadDashboard = false) { 
        setStatus('dashboard-status', 'processing', 'Loading "My Team"...');
        
        google.script.run
          .withSuccessHandler(teamEmails => {
            const select = document.getElementById('dashboard-user-select');
            if (teamEmails && teamEmails.length > 0) {
              Array.from(select.options).forEach(option => {
                option.selected = teamEmails.includes(option.value);
              });
              setStatus('dashboard-status', 'success', 'Loaded "My Team". Click "Load Dashboard" to view.');
            } else {
              // If no team is saved, select nothing (which defaults to 'ALL_USERS' in loadDashboard logic)
              Array.from(select.options).forEach(option => {
                option.selected = false;
              });
              setStatus('dashboard-status', 'success', 'No "My Team" saved. Select users and click "Load Dashboard".');
            }
            
            if (!autoLoadDashboard) {
              loadDashboard();
            }
          })
          .withFailureHandler(err => {
            setStatus('dashboard-status', 'error', err.message);
            if (autoLoadDashboard) {
              loadDashboard();
            }
          })
          .webGetMyTeam();
      }

      // --- Submit Reporting Line Change ---
      function submitReportingLineChange() {
        try {
          const userEmail = document.getElementById('reporting-line-user').value;
          const newSupervisorEmail = document.getElementById('reporting-line-supervisor').value;

          if (!userEmail) throw new Error("Please select a user to move.");
          if (!newSupervisorEmail) throw new Error("Please select a new supervisor.");
          if (userEmail === newSupervisorEmail) throw new Error("A user cannot be their own supervisor.");

          setStatus('reporting-line-status', 'processing', 'Processing reporting line change...');

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) {
                setStatus('reporting-line-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('reporting-line-status', 'success', msg);
                document.getElementById('reporting-line-form').reset();
              }
            })
            .withFailureHandler(err => {
              setStatus('reporting-line-status', 'error', err.message);
            })
            .webUpdateReportingLine(userEmail, newSupervisorEmail);

        } catch (err) {
          setStatus('reporting-line-status', 'error', err.message);
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function() {
        loadUserInfo(); 
        document.getElementById('schedule-start-date').valueAsDate = new Date();
        document.getElementById('leave-start-date').valueAsDate = new Date();
        document.getElementById('history-start-date').valueAsDate = new Date(); 
        document.getElementById('history-end-date').valueAsDate = new Date(); 
        document.getElementById('manual-punch-date').valueAsDate = new Date(); 
        document.getElementById('admin-leave-start-date').valueAsDate = new Date(); 
        document.getElementById('dashboard-date').valueAsDate = new Date();
        toggleTimeFields(); // Initial call to set time fields correctly
      });
    </script>
  </body>
</html>
