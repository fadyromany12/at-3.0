<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>Konecta Adherence Portal (KAP)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- UPDATED: Modern Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart', 'table']});
      google.charts.setOnLoadCallback(() => { chartsLoaded = true; }); 
    </script>
    
    <style>
      /* --- Color Palette & Variables --- */
      :root {
        --konecta-blue: #00a9e0;
        /* UPDATED: User's new Dark Blue */
        --konecta-dark: #2101cd; 
        /* UPDATED: User's new Yellow/Lime */
        --konecta-yellow: #f0fa00; 
        /* Kept original gray for text readability */
        --konecta-gray: #5f6368; 
        --google-green: #34a853;
        --google-red: #ea4335;
        --card-bg: #ffffff;
        --page-bg: #f4f7f6;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --radius: 12px;
        --border-color: #e0e0e0;
      }
      
      /* --- Global Styles --- */
      body, html {
        font-family: 'Inter', Arial, sans-serif; 
        margin: 0; 
        padding: 0;
        background-color: var(--page-bg);
        color: var(--konecta-dark);
      }

      /* --- Header with Logo --- */
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 40px;
        background-color: var(--card-bg);
        border-bottom: 2px solid var(--border-color);
        position: relative; /* For refresh button */
      }
      header img {
        height: 35px;
        width: auto;
      }
      header h1 { 
        color: var(--konecta-dark);
        text-align: right;
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
        /* NEW: Make space for refresh button */
        display: flex;
        align-items: center;
      }
      
      .header-kap {
        color: var(--konecta-blue);
        font-weight: 700;
        font-size: 1.4rem; /* Slightly smaller */
        margin-left: 5px;
      }
      
      /* --- NEW: Header Refresh Button --- */
      #header-refresh-button {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
        opacity: 0.7;
        transition: all 0.2s;
        min-width: auto;
        margin: 0 0 0 15px; /* Space from title */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #header-refresh-button:hover {
        opacity: 1;
        transform: scale(1.1);
        background-color: #f0f0f0;
        box-shadow: none;
      }
      /* UPDATED: Changed from 'svg' to 'img' */
      #header-refresh-button img {
        width: 20px;
        height: 20px;
        /* fill: var(--konecta-blue); <-- Removed 'fill', as it only works on SVGs */
      }
      /* UPDATED: Changed from 'svg' to 'img' */
      #header-refresh-button.loading img {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      /* --- End Refresh Button --- */
      
      /* --- Centered Card Layout --- */
      main {
        max-width: 960px;
        margin: 30px auto;
        background-color: var(--card-bg);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden; /* Keep rounded corners */
      }
      
      /* --- Tab Navigation --- */
      #tab-nav {
        background-color: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        text-align: center;
        padding-top: 10px;
        display: flex;
        justify-content: center;
        flex-wrap: wrap; /* Allow tabs to wrap on small screens */
      }
      .tab-button {
        padding: 14px 20px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        background-color: transparent;
        border-bottom: 3px solid transparent;
        transition: border-color 0.3s, color 0.3s;
        color: var(--konecta-gray);
      }
      .tab-button.active {
        color: var(--konecta-blue);
        border-bottom: 3px solid var(--konecta-blue);
      }
      #schedule-tab-button, #leave-approval-tab-button, #admin-tools-tab-button, #history-report-tab-button, #dashboard-tab-button, #my-schedule-tab-button, #reporting-line-tab-button {
        display: none; /* All hidden by default */
      }
      
      /* --- Container for all content --- */
      .content-container {
        padding: 30px;
      }
      
      /* --- Tab Panels --- */
      .tab-panel {
        display: none; /* All panels hidden by default */
      }
      #punch-panel {
        display: block; /* Show punch panel by default */
      }
      
      #agent-info { 
        margin-bottom: 20px; 
        padding: 15px;
        background-color: #f7f9fa;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        text-align: center;
        font-size: 1.1em;
        position: relative; 
      }
      
      #admin-panel {
        display: none; /* Hidden by default */
        /* UPDATED: Use new yellow */
        background-color: #f0fa0033; /* Yellow with 20% opacity */
        border: 1px solid var(--konecta-yellow);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
      }
      #admin-panel label {
        font-weight: 600;
        margin-right: 10px;
        color: var(--konecta-dark);
      }
      #agent-select {
        font-size: 1em;
        padding: 5px 8px;
        border-radius: 5px;
        border: 1px solid var(--border-color);
      }

      #buttons, #other-buttons {
        padding: 0;
        background-color: transparent;
        border-radius: 0;
        box-shadow: none;
        text-align: center;
      }
      #buttons {
         display: none; /* Hidden by default */
      }
      
      #other-buttons {
        display: none; /* Hidden by default */
        margin-top: 20px;
      }

      button {
        margin: 8px;
        padding: 12px 20px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        background-color: var(--konecta-blue);
        color: white;
        transition: background-color 0.3s, box-shadow 0.3s;
        min-width: 150px;
      }
      button:hover {
        background-color: #008fbc; /* Darker blue */
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      }
      
      #other-buttons button {
        background-color: var(--konecta-gray); /* Kept original gray */
      }
       #other-buttons button:hover {
        background-color: #3c4043;
      }
      
      .button-group {
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
      }
      .button-group:last-of-type {
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
      }
      
      /* --- Alert/Status Styles --- */
      #status, #schedule-status, #leave-status, #approval-status, #my-history-status, #manual-punch-status, #admin-leave-status, #csv-import-status, #balance-adjust-status, #my-schedule-status, #dashboard-status, #reporting-line-status {
        margin-top: 20px;
        padding: 12px;
        border-radius: 8px;
        min-height: 30px;
        font-size: 1.1em;
        text-align: center;
        visibility: hidden;
        border: 1px solid transparent;
      }
      #status.success, #schedule-status.success, #leave-status.success, #approval-status.success, #my-history-status.success, #manual-punch-status.success, #admin-leave-status.success, #csv-import-status.success, #balance-adjust-status.success, #my-schedule-status.success, #dashboard-status.success, #reporting-line-status.success { 
        background-color: #edfbf3; 
        color: #2a6944; 
        border-color: #b8e9c9;
        visibility: visible; 
      }
      #status.error, #schedule-status.error, #leave-status.error, #approval-status.error, #my-history-status.error, #manual-punch-status.error, #admin-leave-status.error, #csv-import-status.error, #balance-adjust-status.error, #my-schedule-status.error, #dashboard-status.error, #reporting-line-status.error { 
        background-color: #fdebee; 
        color: #c53030; 
        border-color: #fbb2b2;
        visibility: visible; 
      }
      #status.processing, #schedule-status.processing, #leave-status.processing, #approval-status.processing, #my-history-status.processing, #manual-punch-status.processing, #admin-leave-status.processing, #csv-import-status.processing, #balance-adjust-status.processing, #my-schedule-status.processing, #dashboard-status.processing, #reporting-line-status.processing { 
        background-color: #feefc3; 
        color: #744210; 
        border-color: #f9da8a;
        visibility: visible; 
      }
      
      /* --- Form Styles (reusable) --- */
      .form-container {
        background-color: transparent;
        padding: 0;
        border-radius: 0;
        box-shadow: none;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .form-group select, .form-group input, .form-group textarea {
        width: 100%;
        padding: 12px;
        font-size: 1em;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        box-sizing: border-box; /* Important for 100% width */
        background-color: #f8f9fa;
        font-family: 'Inter', Arial, sans-serif;
      }
      .form-row {
        display: flex;
        gap: 15px;
      }
      .form-row .form-group {
        flex: 1;
      }
      
      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }
      .form-group small {
        display: block;
        margin-top: 6px;
        font-size: 0.85rem;
        color: var(--konecta-gray);
      }
      
      .form-container button {
        width: 100%;
        background-color: var(--google-green);
      }
      .form-container button:hover {
        background-color: #2c8c45;
      }
      
      /* --- Leave Balance Display --- */
      #leave-balances {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        background-color: #f7f9fa;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
      }
      .balance-item {
        flex: 1;
        text-align: center;
      }
      .balance-item p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--konecta-gray);
        font-weight: 500;
      }
      .balance-item .balance-days {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--konecta-blue);
      }
      
      /* --- Leave List Styles --- */
      .request-list {
        margin-top: 30px;
        border-top: 1px solid var(--border-color);
        padding-top: 20px;
      }
      .request-list-item {
        background-color: #f7f9fa;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start; /* Align top */
        gap: 15px;
      }
      .request-list-item .item-number {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--konecta-blue);
        min-width: 25px;
        padding-top: 2px;
      }
      .request-list-item .item-details {
        flex: 1;
      }
      .request-list-item .item-details h4 {
        margin: 0 0 10px 0;
        color: var(--konecta-dark);
      }
      .request-list-item .item-details p {
        margin: 4px 0;
        font-size: 0.95rem;
      }
      .request-list-item .item-details .supervisor-info,
      .request-list-item .item-details .balance-info {
        font-style: italic;
        color: var(--konecta-gray);
        font-size: 0.9rem;
        margin-top: 8px;
      }
      .request-list-item .item-actions {
        min-width: 150px;
        text-align: right;
      }
      .status-badge {
        display: inline-block;
        padding: 5px 12px;
        font-size: 0.9rem;
        font-weight: 600;
        border-radius: 20px;
        margin-top: 5px;
      }
      .status-pending { background-color: #feefc3; color: #744210; }
      .status-approved { background-color: #edfbf3; color: #2a6944; }
      .status-denied { background-color: #fdebee; color: #c53030; }
      .item-actions .approve-btn,
      .item-actions .deny-btn {
        min-width: 100px;
        padding: 8px 12px;
        font-size: 14px;
        margin: 4px;
      }
      .approve-btn { background-color: var(--google-green); }
      .approve-btn:hover { background-color: #2c8c45; }
      .deny-btn { background-color: var(--google-red); }
      .deny-btn:hover { background-color: #b92c2c; }
      
      /* --- Approval Filter Buttons --- */
      #approval-filter-nav {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .filter-button {
        flex: 1;
        padding: 10px 15px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: #f8f9fa;
        color: var(--konecta-gray);
        cursor: pointer;
        transition: all 0.2s;
      }
      .filter-button:hover {
        background-color: #f1f3f4;
      }
      .filter-button.active {
        background-color: var(--konecta-blue);
        color: white;
        border-color: var(--konecta-blue);
      }
      
      /* --- History Report Styles --- */
      #history-report-form {
        display: flex;
        flex-wrap: wrap; 
        gap: 15px;
        align-items: flex-end;
      }
      #history-report-form .form-group {
        flex: 1;
        min-width: 150px; 
        margin-bottom: 0;
      }
      #history-user-select {
        height: 120px;
        padding: 10px;
      }
      #history-report-form button {
        width: auto;
        min-width: 150px;
        margin: 0 0 0 10px;
      }
      #history-report-form .view-btn {
        background-color: var(--konecta-dark);
      }
      #history-report-form .view-btn:hover {
        background-color: #1a0199;
      }
      #history-report-form .export-btn {
        background-color: var(--konecta-gray);
        display: none; 
      }
      #history-report-form .export-btn:hover {
        background-color: #3c4043;
      }
      
      #history-report-display {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
        overflow-x: auto; 
      }
      .report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }
      .report-table th, .report-table td {
        border: 1px solid var(--border-color);
        padding: 10px;
        text-align: left;
      }
      .report-table th {
        background-color: #f7f9fa;
        font-weight: 600;
      }
      .report-table .highlight-red {
        color: var(--google-red);
        font-weight: bold;
      }
      .report-table .highlight-green {
        color: var(--google-green);
        font-weight: bold;
      }

      /* --- Section divider --- */
      .section-divider {
        border: 0;
        border-top: 1px solid var(--border-color);
        margin: 30px 0;
      }
      
      /* --- CSV Importer Styles --- */
      #csv-import-form {
        padding: 20px;
        background-color: #f7f9fa;
        border: 1px solid var(--border-color);
        border-radius: 8px;
      }
      #csv-import-form .form-group {
        margin-bottom: 0;
      }
      #csv-import-form button {
        width: 100%;
        background-color: var(--konecta-dark);
      }
      #csv-import-form button:hover {
        background-color: #1a0199;
      }

      /* --- Dashboard Styles (UPDATED) --- */
      #dashboard-controls {
        background-color: #f7f9fa;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
      /* NEW: Dashboard form layout */
      #dashboard-form {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-end;
      }
      #dashboard-form .form-group {
        flex: 1;
        min-width: 150px;
        margin-bottom: 0;
      }
      #dashboard-user-select {
        height: 150px;
      }
      #dashboard-filters {
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-width: 180px;
      }
      #dashboard-filters button {
        width: 100%;
        margin: 0;
      }
      
      #dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .dashboard-card {
        background-color: #f7f9fa;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
      }
      .dashboard-card h3 {
        margin: 0 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
      }
      .chart-container {
        width: 100%;
        height: 350px;
      }
      /* NEW: Adherence detail table container */
      .table-container {
        width: 100%;
        height: 350px;
        overflow-y: auto;
      }
      
      @media (max-width: 768px) {
        #dashboard-grid {
          grid-template-columns: 1fr;
        }
        #dashboard-form {
          flex-direction: column;
          align-items: stretch;
        }
        #dashboard-filters {
          flex-direction: row;
        }
      }

      /* --- My Schedule Table Styles --- */
      .schedule-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .schedule-table th, .schedule-table td {
        border: 1px solid var(--border-color);
        padding: 12px;
        text-align: left;
      }
      .schedule-table th {
        background-color: #f7f9fa;
        font-weight: 600;
      }
      .schedule-table .day-past {
        color: var(--konecta-gray);
        background-color: #f1f3f4;
      }
      .schedule-table .day-today {
        font-weight: 700;
        background-color: #feefc3;
      }
      .schedule-table .status-leave {
        font-weight: 600;
        color: var(--konecta-blue);
      }

      /* --- Footer Signature --- */
      footer {
        text-align: center;
        padding: 25px;
        margin-top: 10px;
        font-size: 0.8rem;
        color: #aaa;
      }
    </style>
  </head>
  <body>
    <header>
      <img src="https://th.bing.com/th/id/OIP.gafgWpiLoUVHSxGah643xQHaCa?w=338&h=114&c=7&r=0&o=7&dpr=1.3&pid=1.7&rm=3" alt="Konecta Logo">
      <h1>
        Konecta Adherence Portal <span class="header-kap">(KAP)</span>
        <!-- NEW: Header Refresh Button -->
        <button id="header-refresh-button" title="Refresh Data" onclick="refreshCurrentData()">
          <!-- UPDATED: Replaced SVG with your IMG tag -->
          <img src="https://icons.veryicon.com/png/o/miscellaneous/two-color-webpage-small-icon/refresh-174.png" alt="Refresh Icon">
        </button>
      </h1>
    </header>

    <main>
      <div id="tab-nav">
        <button id="dashboard-tab-button" class="tab-button" onclick="showTab('dashboard')">Dashboard</button>
        <button id="punch-tab-button" class="tab-button active" onclick="showTab('punch')">Punch</button>
        <button id="my-schedule-tab-button" class="tab-button" onclick="showTab('my-schedule')">My Schedule</button>
        <button id="leave-request-tab-button" class="tab-button" onclick="showTab('leave-request')">My Leave</button> 
        <button id="history-report-tab-button" class="tab-button" onclick="showTab('history-report')">History Report</button>
        <button id="schedule-tab-button" class="tab-button" onclick="showTab('schedule')">Schedule Editor</button>
        <button id="leave-approval-tab-button" class="tab-button" onclick="showTab('leave-approval')">Leave Approvals</button>
        <button id="admin-tools-tab-button" class="tab-button" onclick="showTab('admin-tools')">Admin Tools</button>
        <!-- NEW: Reporting Line Tab -->
        <button id="reporting-line-tab-button" class="tab-button" onclick="showTab('reporting-line')">Reporting Line</button>
      </div>

      <div class="content-container">

        <!-- ================================== -->
        <!--      TAB 1: PUNCH PANEL            -->
        <!-- ================================== -->
        <div id="punch-panel" class="tab-panel">
          <!-- REMOVED refresh button from here -->
          <div id="agent-info">Loading user info...</div> 
          <div id="admin-panel"><label for="agent-select">Punch For:</label><select id="agent-select"></select></div>
          <div id="buttons">
            <div class="button-group"><button onclick="punch('Login')">Login</button></div>
            <div class="button-group"><button onclick="punch('First Break In')">1st Break In</button><button onclick="punch('First Break Out')">1st Break Out</button></div>
            <div class="button-group"><button onclick="punch('Lunch In')">Lunch In</button><button onclick="punch('Lunch Out')">Lunch Out</button></div>
            <div class="button-group"><button onclick="punch('Last Break In')">Last Break In</button><button onclick="punch('Last Break Out')">Last Break Out</button></div>
            <div class="button-group"><button onclick="punch('Logout')">Logout</button></div>
          </div>
          <div id="other-buttons">
             <div class="button-group"><button onclick="punch('Coaching In')">Coaching In</button><button onclick="punch('Coaching Out')">Coaching Out</button></div>
            <div class="button-group"><button onclick="punch('Meeting In')">Meeting In</button><button onclick="punch('Meeting Out')">Meeting Out</button></div>
             <div class="button-group"><button onclick="punch('Personal In')">Personal In</button><button onclick="punch('Personal Out')">Personal Out</button></div>
          </div>
          <div id="status"></div>
        </div>

        <!-- ================================== -->
        <!--      TAB 2: MY SCHEDULE PANEL      -->
        <!-- ================================== -->
        <div id="my-schedule-panel" class="tab-panel">
          <h2>My Upcoming Schedule</h2>
          <p>This shows your schedule for the next 7 days, including today.</p>
          <div id="my-schedule-status"></div>
          <div id="my-schedule-display"></div>
        </div>

        <!-- ================================== -->
        <!--     TAB 3: MY LEAVE PANEL          -->
        <!-- ================================== -->
        <div id="leave-request-panel" class="tab-panel">
          <h2>My Balances</h2>
          <div id="leave-balances">
            <div class="balance-item"><p>Annual</p><span class="balance-days" id="balance-annual">--</span></div>
            <div class="balance-item"><p>Sick</p><span class="balance-days" id="balance-sick">--</span></div>
            <div class="balance-item"><p>Casual</p><span class="balance-days" id="balance-casual">--</span></div>
          </div>
          <form id="leave-form" class="form-container">
            <h2>Submit Leave Request</h2>
            <!-- REMOVED Supervisor Dropdown -->
            <div class="form-group"><label for="leave-type">Leave Type</label><select id="leave-type"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Casual">Casual</option></select></div>
            <div class="form-group"><label for="leave-start-date">Start Date</label><input type="date" id="leave-start-date" required></div>
            <div class="form-group"><label for="leave-end-date">End Date</label><input type="date" id="leave-end-date"><small>Leave blank for a single-day request.</small></div>
            <div class="form-group"><label for="leave-reason">Reason (Optional)</label><textarea id="leave-reason" rows="3"></textarea></div>
            <button type="button" onclick="submitLeaveRequest()">Submit Request</button>
          </form>
          <div id="leave-status"></div>
          <div class="request-list">
            <h2>My Request History</h2>
            <div id="my-requests-list" class="request-list"></div>
          </div>
        </div>
        
        <!-- ================================== -->
        <!--    TAB 4: HISTORY REPORT PANEL     -->
        <!-- ================================== -->
        <div id="history-report-panel" class="tab-panel">
          <h2>Adherence History Report</h2>
          <form id="history-report-form" class="form-container">
            <div class="form-group" id="history-user-select-group" style="display: none;">
              <label for="history-user-select">Select User(s) (Ctrl+Click)</label>
              <select id="history-user-select" multiple></select>
            </div>
            <div class="form-group">
              <label for="history-start-date">Start Date</label>
              <input type="date" id="history-start-date" required>
            </div>
            <div class="form-group">
              <label for="history-end-date">End Date</label>
              <input type="date" id="history-end-date" required>
            </div>
            <button type="button" class="view-btn" onclick="loadHistoryReport()">View History</button>
            <button type="button" class="export-btn" id="export-csv-btn" onclick="exportHistoryToCSV()">Export to CSV</button>
          </form>
          
          <div id="my-history-status"></div>
          <div id="history-report-display">
             <!-- History data will be loaded here -->
          </div>
        </div>

        <!-- ================================== -->
        <!--    TAB 5: SCHEDULE EDITOR PANEL    -->
        <!-- ================================== -->
        <div id="schedule-panel" class="tab-panel">
          <form id="csv-import-form" class="form-container">
            <h2>Bulk Schedule Importer (CSV)</h2>
            <p>Upload a CSV file with headers: `Name`, `Date` (MM/dd/yyyy), `StartTime` (HH:mm), `EndTime` (HH:mm), `LeaveType`, `Email`</p>
            <div class="form-group">
              <label for="csv-file-input">Select CSV File</label>
              <input type="file" id="csv-file-input" accept=".csv">
            </div>
            <button type="button" onclick="importScheduleCSV()">Import CSV</button>
          </form>
          <div id="csv-import-status"></div>
          
          <hr class="section-divider">
          
          <form id="schedule-form" class="form-container">
            <h2>Manual Schedule Editor</h2>
            <div class="form-group"><label for="schedule-agent-select">User</label><select id="schedule-agent-select"></select></div>
            <div class="form-group"><label for="schedule-start-date">Start Date</label><input type="date" id="schedule-start-date" required></div>
            <div class="form-group"><label for="schedule-end-date">End Date (Optional)</label><input type="date" id="schedule-end-date"><small>Leave blank to submit for a single day.</small></div>
            <div class="form-group"><label for="schedule-leave-type">Leave Type / Status</label><select id="schedule-leave-type" onchange="toggleTimeFields()"><option value="Present">Present</option><option value="Sick">Sick</option><option value="Annual">Annual</option><option value="Casual">Casual</option><option value="Absent">Absent</option></select></div>
            <div id="time-fields"><div class="form-group"><label for="schedule-start-time">Shift Start Time</label><input type="time" id="schedule-start-time"></div><div class="form-group"><label for="schedule-end-time">Shift End Time</label><input type="time" id="schedule-end-time"></div></div>
            <button type="button" onclick="submitSchedule()">Submit Schedule(s)</button>
          </form>
          <div id="schedule-status"></div>
        </div>
        
        <!-- ================================== -->
        <!--   TAB 6: LEAVE APPROVALS PANEL     -->
        <!-- ================================== -->
        <div id="leave-approval-panel" class="tab-panel">
          <h2>Pending Leave Approvals</h2>
          <div id="approval-filter-nav">
            <button id="filter-mine" class="filter-button" onclick="loadPendingRequests('mine')">My Pending Requests</button>
            <button id="filter-all" class="filter-button" onclick="loadPendingRequests('all')">All Pending Requests</button>
          </div>
          <div id="approval-status"></div>
          <div id="pending-requests-list" class="request-list"></div>
        </div>
        
        <!-- ================================== -->
        <!--     TAB 7: ADMIN TOOLS PANEL       -->
        <!-- ================================== -->
        <div id="admin-tools-panel" class="tab-panel">
          <form id="manual-punch-form" class="form-container">
            <h2>Manual Punch Editor</h2>
            <p>Manually add or overwrite a punch for a user. This will bypass duplicate/sequential checks and recalculate metrics.</p>
            <div class="form-group"><label for="manual-punch-user">User</label><select id="manual-punch-user" required></select></div>
            <div class="form-group"><label for="manual-punch-action">Punch Action</label><select id="manual-punch-action" required><option value="">-- Select an action --</option><optgroup label="Adherence"><option value="Login">Login</option><option value="First Break In">First Break In</option><option value="First Break Out">First Break Out</option><option value="Lunch In">Lunch In</option><option value="Lunch Out">Lunch Out</option><option value="Last Break In">Last Break In</option><option value="Last Break Out">Last Break Out</option><option value="Logout">Logout</option></optgroup><optgroup label="Other Codes"><option value="Coaching In">Coaching In</option><option value="Coaching Out">Coaching Out</option><option value="Meeting In">Meeting In</option><option value="Meeting Out">Meeting Out</option><option value="Personal In">Personal In</option><option value="Personal Out">Personal Out</option></optgroup></select></div>
            <div class="form-row"><div class="form-group"><label for="manual-punch-date">Date of Punch</label><input type="date" id="manual-punch-date" required></div><div class="form-group"><label for="manual-punch-time">Time of Punch</label><input type="time" id="manual-punch-time" required></div></div>
            <button type="button" onclick="submitManualPunch()" style="background-color:var(--konecta-dark)">Submit Manual Punch</button>
          </form>
          <div id="manual-punch-status"></div>
          
          <hr class="section-divider">
          
           <form id="balance-adjustment-form" class="form-container">
            <h2>Leave Balance Management</h2>
            <p>Manually adjust a user's leave balance. Use a positive number (e.g., 2) to add days, and a negative number (e.g., -1) to remove days.</p>
            <div class="form-group"><label for="balance-user-select">Select User</label><select id="balance-user-select" required></select></div>
            <div class="form-row">
              <div class="form-group"><label for="balance-leave-type">Leave Type</label><select id="balance-leave-type"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Casual">Casual</option></select></div>
              <div class="form-group"><label for="balance-amount">Amount to Adjust</label><input type="number" id="balance-amount" step="0.5" placeholder="e.g., -1 or 1.5" required></div>
            </div>
            <div class="form-group"><label for="balance-reason">Reason for Adjustment</label><textarea id="balance-reason" rows="2" required></textarea></div>
            <button type="button" onclick="submitBalanceAdjustment()" style="background-color:var(--google-yellow); color:black;">Submit Balance Adjustment</button>
          </form>
          <div id="balance-adjust-status"></div>

          <hr class="section-divider">
          
          <form id="admin-leave-form" class="form-container">
            <h2>Submit Leave on Behalf of User</h2>
            <p>Submit a leave request for a user. This will check their balance and send it to their assigned supervisor for approval.</p>
            <div class="form-group"><label for="admin-leave-user">Select User</LabeL><select id="admin-leave-user" required></select></div>
            <!-- REMOVED Supervisor Dropdown -->
            <div class="form-group"><label for="admin-leave-type">Leave Type</label><select id="admin-leave-type"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Casual">Casual</option></select></div>
            <div class="form-row"><div class="form-group"><label for="admin-leave-start-date">Start Date</label><input type="date" id="admin-leave-start-date" required></div><div class="form-group"><label for="admin-leave-end-date">End Date</label><input type="date" id="admin-leave-end-date"><small>Leave blank for a single-day request.</small></div></div>
            <div class="form-group"><label for="admin-leave-reason">Reason (Optional)</label><textarea id="admin-leave-reason" rows="3"></textarea></div>
            <button type="button" onclick="submitAdminLeaveRequest()">Submit Request for User</button>
          </form>
          
          <div id="admin-leave-status"></div>
        </div>

        <!-- ================================== -->
        <!--     TAB 8: DASHBOARD PANEL         -->
        <!-- ================================== -->
        <div id="dashboard-panel" class="tab-panel">
          
          <!-- UPDATED: Dashboard Controls -->
          <div id="dashboard-controls" class="form-container">
            <form id="dashboard-form">
              <div class="form-group">
                <label for="dashboard-user-select">Select Users (Ctrl+Click)</label>
                <select id="dashboard-user-select" multiple></select>
              </div>
              <div class="form-group">
                <label for="dashboard-date">Select Date</label>
                <input type="date" id="dashboard-date" required>
              </div>
              <div id="dashboard-filters">
                <button type="button" style="background-color:var(--konecta-dark);" onclick="loadDashboard()">Load Dashboard</button>
                <button type="button" style="background-color:var(--konecta-blue);" onclick="loadMyTeam()">Load My Team</button>
                <button type="button" style="background-color:var(--google-green);" onclick="saveMyTeam()">Save as My Team</button>
              </div>
            </form>
          </div>
          <div id="dashboard-status"></div>
          
          <hr class="section-divider">
          
          <h2 id="dashboard-title">Team Dashboard</h2>
          <div id="dashboard-grid">
            <div class="dashboard-card">
              <h3>Current User Status</h3>
              <div id="status-pie-chart" class="chart-container"></div>
            </div>
            <div class="dashboard-card">
              <h3>Total Adherence Metrics</h3>
              <div id="adherence-bar-chart" class="chart-container"></div>
            </div>
            <div class="dashboard-card" style="grid-column: 1 / -1;">
              <h3>Adherence Details</h3>
              <div id="adherence-detail-table" class="table-container"></div>
            </div>
            <div class="dashboard-card" style="grid-column: 1 / -1;">
              <h3>Pending Leave Requests (for selected users)</h3>
              <div id="pending-leave-table" class="chart-container"></div>
            </div>
          </div>
        </div>
        
        <!-- ================================== -->
        <!--    NEW TAB 9: REPORTING LINE       -->
        <!-- ================================== -->
        <div id="reporting-line-panel" class="tab-panel">
          <form id="reporting-line-form" class="form-container">
            <h2>Update User Reporting Line</h2>
            <p>Select a user and assign them to a new supervisor. The change will be logged. If you are a manager, you can only move users between supervisors who report to you. Superadmins can move any user.</p>
            
            <div class="form-group">
              <label for="reporting-line-user">Select User to Move</label>
              <select id="reporting-line-user" required>
                <!-- Admin-only list of users -->
              </select>
            </div>
            
            <div class="form-group">
              <label for="reporting-line-supervisor">Assign to New Supervisor</label>
              <select id="reporting-line-supervisor" required>
                <!-- Admin-only list of supervisors -->
              </select>
            </div>
            
            <button type="button" onclick="submitReportingLineChange()" style="background-color:var(--konecta-dark)">Update Reporting Line</button>
          </form>
          <div id="reporting-line-status"></div>
        </div>

      </div> <!-- End .content-container -->
    </main> <!-- End .card -->

    <footer>
      <p>Created by Fady Bekhet</p>
    </footer>


    <script>
      let selfUserName = ""; 
      let selfRole = "agent"; 
      let allUsersList = []; 
      let allAdminsList = []; 
      let lastHistoryData = null;
      let chartsLoaded = false; 
      // const timeZone = "<?= Session.getScriptTimeZone() ?>"; 

      // === UPDATED: TAB SWITCHING FUNCTION (Bug Fix) ===
      function showTab(tabName) {
        // Hide all panels
        document.getElementById('punch-panel').style.display = 'none';
        document.getElementById('schedule-panel').style.display = 'none';
        document.getElementById('leave-request-panel').style.display = 'none';
        document.getElementById('leave-approval-panel').style.display = 'none';
        document.getElementById('history-report-panel').style.display = 'none'; 
        document.getElementById('admin-tools-panel').style.display = 'none'; 
        document.getElementById('my-schedule-panel').style.display = 'none';
        document.getElementById('dashboard-panel').style.display = 'none';
        document.getElementById('reporting-line-panel').style.display = 'none'; // NEW

        // Deactivate all tab buttons
        document.getElementById('punch-tab-button').classList.remove('active');
        document.getElementById('schedule-tab-button').classList.remove('active');
        document.getElementById('leave-request-tab-button').classList.remove('active');
        document.getElementById('leave-approval-tab-button').classList.remove('active');
        document.getElementById('history-report-tab-button').classList.remove('active'); 
        document.getElementById('admin-tools-tab-button').classList.remove('active'); 
        document.getElementById('my-schedule-tab-button').classList.remove('active');
        document.getElementById('dashboard-tab-button').classList.remove('active');
        document.getElementById('reporting-line-tab-button').classList.remove('active'); // NEW
        
        // Show the correct panel and activate the correct button
        document.getElementById(tabName + '-panel').style.display = 'block';
        document.getElementById(tabName + '-tab-button').classList.add('active');
        
        // --- THIS IS THE FIX: Refresh data when tabs are clicked ---
        if (tabName === 'leave-approval') {
          const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
          loadPendingRequests(currentFilter);
        } else if (tabName === 'leave-request') {
          loadMyRequests();
          // Also refresh balances
          google.script.run.withSuccessHandler(user => {
            if(user && user.myBalances) populateMyBalances(user.myBalances);
          }).getUserInfo();
        } else if (tabName === 'my-schedule') {
          loadMySchedule();
        } 
        // --- END FIX ---
      }
      
      // --- NEW: Refresh User Info ---
      function refreshCurrentData() {
        const btn = document.getElementById('header-refresh-button');
        btn.classList.add('loading');
        
        // Find active tab
        const activeTab = document.querySelector('.tab-button.active');
        const activeTabId = activeTab ? activeTab.id : 'punch-tab-button';
        
        // Re-load user info (which populates dropdowns and balances)
        google.script.run
          .withSuccessHandler(user => {
            // Repopulate user info first
            populateUserInfo(user); 
            
            // Now, reload the data for the specific tab
            if (activeTabId === 'leave-approval-tab-button') {
              const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
              loadPendingRequests(currentFilter);
            } else if (activeTabId === 'leave-request-tab-button') {
              loadMyRequests();
            } else if (activeTabId === 'my-schedule-tab-button') {
              loadMySchedule();
            } else if (activeTabId === 'dashboard-tab-button') {
              loadDashboard();
            } else if (activeTabId === 'history-report-tab-button' && lastHistoryData) {
              loadHistoryReport(); // Re-run the last report
            }
            
            // Remove loading spinner
            setTimeout(() => {
              btn.classList.remove('loading');
            }, 500); // Short delay
          })
          .withFailureHandler(err => {
            btn.classList.remove('loading');
            // Show error in the main info box
            const infoDiv = document.getElementById('agent-info');
            infoDiv.innerHTML = "Error refreshing data. Please try again.";
            infoDiv.style.color = "#c53030";
            infoDiv.style.backgroundColor = "#fdebee";
          })
          .getUserInfo();
      }

      // NEW: Extracted user info population into its own function
      function populateUserInfo(user) {
        const infoDiv = document.getElementById('agent-info');
        if (!user || !user.name && (user.role === 'agent' || !user.email.includes("konecta.com"))) {
          infoDiv.innerHTML = "Your email is not registered. Contact your supervisor.";
          infoDiv.style.color = "#c53030";
          infoDiv.style.backgroundColor = "#fdebee";
          return;
        }

        selfUserName = user.name; 
        selfRole = user.role; 
        allUsersList = user.allUsers; 
        allAdminsList = user.allAdmins; 
        
        let displayRole = user.role;
        if (displayRole === 'superadmin') {
          displayRole = 'Superadmin';
        } else if (displayRole === 'admin') {
          displayRole = 'Admin';
        } else if (displayRole === 'agent') {
          displayRole = 'User';
        }
        
        // REMOVED refresh button from inner HTML
        infoDiv.innerHTML = `<strong>User:</strong> ${user.name || 'ADMIN'} <br><strong>Email:</strong> ${user.email} <br><strong>Role:</strong> ${displayRole}`; 
        
        document.getElementById('buttons').style.display = 'block';
        document.getElementById('other-buttons').style.display = 'block';
        document.getElementById('my-schedule-tab-button').style.display = 'inline-block';
        
        // populateSupervisorDropdown(allAdminsList); // This is now removed
        if (user.myBalances) populateMyBalances(user.myBalances);

        // --- Show/Hide Tabs Based on Role ---
        if (user.role === 'admin' || user.role === 'superadmin') {
          document.getElementById('dashboard-tab-button').style.display = 'inline-block';
          document.getElementById('schedule-tab-button').style.display = 'inline-block';
          document.getElementById('leave-approval-tab-button').style.display = 'inline-block';
          document.getElementById('admin-tools-tab-button').style.display = 'inline-block'; 
          document.getElementById('history-report-tab-button').style.display = 'inline-block'; 
          document.getElementById('history-user-select-group').style.display = 'block'; 
          document.getElementById('reporting-line-tab-button').style.display = 'inline-block'; // NEW
          
          populateAdminDropdown(allUsersList, selfUserName, 'agent-select', 'Punch for: Myself');
          document.getElementById('admin-panel').style.display = 'block';
          populateAdminDropdown(allUsersList, selfUserName, 'schedule-agent-select', 'Select a user');
          populateAdminDropdown(allUsersList, selfUserName, 'manual-punch-user', 'Select a user'); 
          populateAdminDropdown(allUsersList, selfUserName, 'admin-leave-user', 'Select user to submit for'); 
          // populateSupervisorDropdown(allAdminsList, 'admin-leave-supervisor'); // This is now removed
          populateAdminDropdown(allUsersList, selfUserName, 'history-user-select', 'Select a user'); 
          populateAdminDropdown(allUsersList, selfUserName, 'balance-user-select', 'Select a user');
          populateAdminDropdown(allUsersList, selfUserName, 'dashboard-user-select', 'Select users'); 
          populateAdminDropdown(allUsersList, selfUserName, 'reporting-line-user', 'Select a user'); // NEW
          populateSupervisorDropdown(allAdminsList, 'reporting-line-supervisor'); // NEW
          
          
          if (user.role === 'superadmin') {
            loadPendingRequests('all'); 
          } else {
            loadPendingRequests('mine'); 
          }
          
        } else {
          // User is an agent
          document.getElementById('history-report-tab-button').style.display = 'inline-block'; 
          document.getElementById('history-user-select-group').style.display = 'none'; 
        }
        
        loadMyRequests();
      }

      function loadUserInfo() { 
        const loadTimeout = setTimeout(() => {
          const infoDiv = document.getElementById('agent-info');
          infoDiv.innerHTML = "The request timed out. Please refresh and re-authorize the script if asked. If this persists, contact admin.";
          infoDiv.className = 'error'; 
          infoDiv.style.visibility = 'visible';
          infoDiv.style.textAlign = 'center';
        }, 15000);

        google.script.run
          .withSuccessHandler(user => { 
            clearTimeout(loadTimeout); 
            populateUserInfo(user); // NEW: Call centralized function

            // NEW: Load team, but DON'T auto-load dashboard
            if (user.role === 'admin' || user.role === 'superadmin') {
              // This just selects the team in the dropdown, it doesn't load the chart
              google.script.run.withSuccessHandler(teamEmails => {
                if (teamEmails && teamEmails.length > 0) {
                  const select = document.getElementById('dashboard-user-select');
                  Array.from(select.options).forEach(option => {
                    option.selected = teamEmails.includes(option.value);
                  });
                }
              }).webGetMyTeam(); 
            }
          })
          .withFailureHandler(err => {
            clearTimeout(loadTimeout); 
            const infoDiv = document.getElementById('agent-info');
            let errorMsg = err.message || JSON.stringify(err);
            infoDiv.innerHTML = "Could not load user info. Error: " + errorMsg; 
            infoDiv.style.color = "#c53030";
            infoDiv.style.backgroundColor = "#fdebee";
        }).getUserInfo(); 
      }

      function populateAdminDropdown(users, selfName, dropdownId, selfText) { 
        const select = document.getElementById(dropdownId);
        select.innerHTML = ''; 
        
        let firstOptionText = selfText;
        let firstOptionValue = "";
        
        if (dropdownId === 'agent-select') {
          firstOptionText = `${selfText} (${selfName})`;
          // Find self email from allUsersList
          const selfUser = users.find(u => u.name === selfName);
          firstOptionValue = selfUser ? selfUser.email : '';
        } else if (dropdownId !== 'dashboard-user-select' && dropdownId !== 'history-user-select') {
           const selfOption = document.createElement('option');
           selfOption.value = firstOptionValue; 
           selfOption.textContent = firstOptionText;
           select.appendChild(selfOption);
        }

        users.forEach(user => { 
          const option = document.createElement('option');
          option.value = user.email; // Use EMAIL as value
          option.textContent = `${user.name} (${user.email})`;
          select.appendChild(option);
        });
      }
      
      function populateSupervisorDropdown(admins, dropdownId = 'leave-supervisor') {
        const select = document.getElementById(dropdownId);
        select.innerHTML = '<option value="">-- Select a supervisor --</option>'; 
        
        admins.forEach(admin => {
          const option = document.createElement('option');
          option.value = admin.email; 
          option.textContent = `${admin.name}`; 
          select.appendChild(option);
        });
      }
      
      function populateMyBalances(balances) {
        if (!balances) return;
        document.getElementById('balance-annual').textContent = balances.annual;
        document.getElementById('balance-sick').textContent = balances.sick;
        document.getElementById('balance-casual').textContent = balances.casual;
      }

      function punch(action) {
        const statusDiv = document.getElementById('status');
        const adminSelect = document.getElementById('agent-select');
        let targetUserName = '';
        
        if (selfRole === 'admin' || selfRole === 'superadmin') {
          const selectedEmail = adminSelect.value; // This is now an email
          const user = allUsersList.find(u => u.email === selectedEmail);
          targetUserName = user ? user.name : '';
        } else {
          targetUserName = selfUserName;
        }
        
        if (!targetUserName) { 
           statusDiv.className = 'error';
           statusDiv.innerText = 'Please select a user to punch for.'; 
           return;
        }

        statusDiv.className = 'processing';
        statusDiv.innerText = `Processing "${action}" for ${targetUserName}...`; 

        google.script.run
          .withSuccessHandler(msg => {
            if (msg.startsWith('Error:')) {
              statusDiv.className = 'error';
              statusDiv.innerText = msg.replace('Error: ', '');
            } else {
              statusDiv.className = 'success';
              statusDiv.innerText = msg;
            }
          })
          .withFailureHandler(err => {
            statusDiv.className = 'error';
            let errorMsg = err.message || JSON.stringify(err);
            statusDiv.innerText = 'Unexpected error: ' + errorMsg;
          })
          .webPunch(action, targetUserName, null); // Pass null for timestamp
      }
      
      function toggleTimeFields() {
        const leaveType = document.getElementById('schedule-leave-type').value;
        const timeFields = document.getElementById('time-fields');
        if (leaveType === 'Present') {
          timeFields.style.display = 'block';
        } else {
          timeFields.style.display = 'none';
        }
      }
      
      function submitSchedule() {
        const statusDiv = document.getElementById('schedule-status');
        try {
          const userEmail = document.getElementById('schedule-agent-select').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user."); 
          
          let startDate = document.getElementById('schedule-start-date').value;
          let endDate = document.getElementById('schedule-end-date').value;
          const leaveType = document.getElementById('schedule-leave-type').value;
          let startTime = document.getElementById('schedule-start-time').value;
          let endTime = document.getElementById('schedule-end-time').value;
          
          if (!startDate) throw new Error("Please select a Start Date.");
          if (!endDate) endDate = startDate;
          if (new Date(endDate) < new Date(startDate)) throw new Error("End Date cannot be before Start Date.");
          
          if (leaveType === 'Present') {
            if (!startTime || !endTime) throw new Error("Shift Start and End Time are required for 'Present' status.");
          } else {
            startTime = "";
            endTime = "";
          }
          
          statusDiv.className = 'processing';
          statusDiv.innerText = `Submitting schedule for ${user.name}...`;

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) {
                statusDiv.className = 'error';
                statusDiv.innerText = msg.replace('Error: ', '');
              } else {
                statusDiv.className = 'success';
                statusDiv.innerText = msg;
                document.getElementById('schedule-agent-select').selectedIndex = 0;
                document.getElementById('schedule-start-date').valueAsDate = new Date();
                document.getElementById('schedule-end-date').value = ''; 
                document.getElementById('schedule-leave-type').selectedIndex = 0;
                document.getElementById('schedule-start-time').value = '';
                document.getElementById('schedule-end-time').value = '';
                toggleTimeFields();
              }
            })
            .withFailureHandler(err => {
              statusDiv.className = 'error';
              let errorMsg = err.message || JSON.stringify(err);
              statusDiv.innerText = 'Unexpected error: ' + errorMsg;
            })
            .webSubmitScheduleRange(user.email, user.name, startDate, endDate, startTime, endTime, leaveType); 

        } catch (err) {
          statusDiv.className = 'error';
          statusDiv.innerText = err.message;
        }
      }
      
      // --- Helper to format date strings ---
      function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        return new Date(dateStr).toLocaleDateString("en-US", { 
          year: 'numeric', month: '2-digit', day: '2-digit' 
        });
      }
      
      // --- Helper to format time strings ---
      function formatTime(dateStr) {
        if (!dateStr) return '--:--';
        return new Date(dateStr).toLocaleTimeString("en-US", { 
          hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false 
        });
      }
      
      // --- Helper to format seconds ---
      function formatSeconds(seconds) {
        if (typeof seconds !== 'number' || isNaN(seconds)) return 'N/A';
        if (seconds === 0) return '0 sec';
        const isNegative = seconds < 0;
        if (isNegative) seconds = Math.abs(seconds);
        
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        
        let str = isNegative ? '-' : '';
        if (h > 0) str += `${h}h `;
        if (m > 0) str += `${m}m `;
        if (s > 0 || (h === 0 && m === 0)) str += `${s}s`;
        
        return str.trim();
      }

      // --- === SAFER ERROR HANDLERS === ---
      function onMyRequestsFailure(error) {
        const listDiv = document.getElementById('my-requests-list');
        let errorMsg = "An unknown error occurred."; // Default
        if (typeof error === 'object' && error !== null && error.message) {
          errorMsg = error.message; // Standard error object
        } else if (typeof error === 'string') {
          errorMsg = error; // Just a string
        } else if (error) {
          errorMsg = JSON.stringify(error); // Some other object
        }
        listDiv.innerHTML = `<p style="color: red; font-weight: bold;">Error loading requests: ${errorMsg}</p>`;
      }

      function onPendingRequestsFailure(error) {
        const listDiv = document.getElementById('pending-requests-list');
        let errorMsg = "An unknown error occurred."; // Default
        if (typeof error === 'object' && error !== null && error.message) {
          errorMsg = error.message; // Standard error object
        } else if (typeof error === 'string') {
          errorMsg = error; // Just a string
        } else if (error) {
          errorMsg = JSON.stringify(error); // Some other object
        }
        listDiv.innerHTML = `<p style="color: red; font-weight: bold;">Error loading requests: ${errorMsg}</p>`;
      }
      // --- === END SAFER ERROR HANDLERS === ---

      // --- === `loadMyRequests` (Calls V2) === ---
      function loadMyRequests() {
        google.script.run
          .withSuccessHandler(populateMyRequests)
          .withFailureHandler(onMyRequestsFailure)
          .webGetMyRequests_V2();
      }
      
      // --- === `populateMyRequests` (With try/catch) === ---
      function populateMyRequests(requests) {
        const listDiv = document.getElementById('my-requests-list');
        
        if (typeof requests === 'string' || !Array.isArray(requests)) {
          listDiv.innerHTML = `<p style="color: red; font-weight: bold;">Received an invalid response from server: ${requests}</p>`;
          return;
        }
        
        if (requests.length === 0) {
          listDiv.innerHTML = '<p>You have no leave requests on file.</p>';
          return;
        }
        
        let html = '';
        try { 
          requests.reverse().forEach((req, index) => {
            let statusClass = '';
            if (req.status === 'Pending') statusClass = 'status-pending';
            if (req.status === 'Approved') statusClass = 'status-approved';
            if (req.status === 'Denied') statusClass = 'status-denied';
            
            html += `
              <div class="request-list-item">
                <div class="item-number">${index + 1}.</div>
                <div class="item-details">
                  <h4>${req.leaveType}</h4>
                  <p>
                    <strong>Dates:</strong> ${formatDate(req.startDate)} to ${formatDate(req.endDate)}
                    (${req.totalDays} ${req.totalDays > 1 ? 'days' : 'day'})
                  </p>
                  <p><strong>Submitted:</strong> ${formatDate(req.requestedDate)}</p>
                  ${req.reason ? `<p><strong>Reason:</strong> ${req.reason}</p>` : ''}
                  ${req.supervisorName ? `<p class="supervisor-info"><strong>Supervisor:</strong> ${req.supervisorName}</p>` : ''}
                </div>
                <div class="item-actions">
                  <span class="status-badge ${statusClass}">${req.status}</span>
                </div>
              </div>
            `;
          });
        } catch (e) {
          listDiv.innerHTML = `<p style="color: red; font-weight: bold;">Error rendering list: ${e.message}</p>`;
          return; // Stop execution
        }
        listDiv.innerHTML = html;
      }
      
      // --- Submit New Leave Request ---
      function submitLeaveRequest() {
        const statusDiv = document.getElementById('leave-status');
        try {
          // const supervisorEmail = document.getElementById('leave-supervisor').value; // REMOVED
          const leaveType = document.getElementById('leave-type').value;
          const startDate = document.getElementById('leave-start-date').value;
          let endDate = document.getElementById('leave-end-date').value;
          const reason = document.getElementById('leave-reason').value;
          
          // if (!supervisorEmail) throw new Error("Please select your supervisor."); // REMOVED
          if (!startDate) throw new Error("Please select a Start Date.");
          if (!endDate) endDate = startDate; 
          
          if (new Date(endDate) < new Date(startDate)) {
            throw new Error("End Date cannot be before Start Date.");
          }
          
          const requestObject = {
            // supervisorEmail: supervisorEmail, // REMOVED
            leaveType: leaveType,
            startDate: startDate,
            endDate: endDate,
            reason: reason
          };
          
          statusDiv.className = 'processing';
          statusDiv.innerText = 'Submitting request...';
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                statusDiv.className = 'error';
                statusDiv.innerText = msg.replace('Error: ', '');
              } else {
                statusDiv.className = 'success';
                statusDiv.innerText = msg;
                document.getElementById('leave-form').reset();
                document.getElementById('leave-start-date').valueAsDate = new Date();
                
                // --- THIS IS THE FIX ---
                loadMyRequests();
                google.script.run.withSuccessHandler(user => {
                  populateMyBalances(user.myBalances);
                }).getUserInfo();
                if (selfRole === 'admin' || selfRole === 'superadmin') {
                  const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
                  loadPendingRequests(currentFilter);
                }
                // --- END FIX ---
              }
            })
            .withFailureHandler(err => {
              statusDiv.className = 'error';
              statusDiv.innerText = err.message;
            })
            .webSubmitLeaveRequest(requestObject, null); // Pass null for target user
          
        } catch (err) {
          statusDiv.className = 'error';
          statusDiv.innerText = err.message;
        }
      }
      
      // --- === `loadPendingRequests` (Calls V2) === ---
      function loadPendingRequests(filter) {
        if (!filter) { // Default filter
          filter = (selfRole === 'superadmin') ? 'all' : 'mine';
        }
      
        if (filter === 'mine') {
          document.getElementById('filter-mine').classList.add('active');
          document.getElementById('filter-all').classList.remove('active');
        } else {
          document.getElementById('filter-mine').classList.remove('active');
          document.getElementById('filter-all').classList.add('active');
        }
        
        if (selfRole === 'superadmin') {
           document.getElementById('filter-all').style.display = 'inline-block';
        } else {
           document.getElementById('filter-all').style.display = 'none';
        }
        
        google.script.run
          .withSuccessHandler(populatePendingRequests)
          .withFailureHandler(onPendingRequestsFailure)
          .webGetPendingRequests_V2(filter);
      }
      
      // --- === `populatePendingRequests` (With try/catch) === ---
      function populatePendingRequests(requests) {
        const listDiv = document.getElementById('pending-requests-list');
        
        if (typeof requests === 'string' || !Array.isArray(requests)) {
          listDiv.innerHTML = `<p style="color: red; font-weight: bold;">Received an invalid response from server: ${requests}</p>`;
          return;
        }

        if (!requests || requests.length === 0) {
          listDiv.innerHTML = '<p>There are no pending leave requests in this view.</p>';
          return;
        }
        
        let html = '';
        try { // <-- NEW SAFETY TRY/CATCH
          requests.forEach((req, index) => {
            let balanceInfo = '';
            if (req.requesterBalance) {
              const balanceKey = req.leaveType.toLowerCase();
              const daysLeft = req.requesterBalance[balanceKey];
              balanceInfo = `<p class="balance-info">User has ${daysLeft} ${req.leaveType} days remaining.</p>`;
            }
        
            html += `
              <div class="request-list-item">
                <div class="item-number">${index + 1}.</div>
                <div class="item-details">
                  <h4>${req.requestedByName} - ${req.leaveType}</h4>
                  <p>
                    <strong>Dates:</strong> ${formatDate(req.startDate)} to ${formatDate(req.endDate)}
                    (${req.totalDays} ${req.totalDays > 1 ? 'days' : 'day'})
                  </p>
                  <p><strong>Submitted:</strong> ${formatDate(req.requestedDate)}</p>
                  ${req.reason ? `<p><strong>Reason:</strong> ${req.reason}</p>` : ''}
                  ${req.supervisorName ? `<p class="supervisor-info"><strong>Assigned to:</strong> ${req.supervisorName}</p>` : ''}
                  ${balanceInfo} 
                </div>
                <div class="item-actions">
                  <button class="approve-btn" onclick="approveDenyRequest('${req.requestID}', 'Approved')">Approve</button>
                  <button class="deny-btn" onclick="approveDenyRequest('${req.requestID}', 'Denied')">Deny</button>
                </div>
              </div>
            `;
          });
        } catch (e) {
          listDiv.innerHTML = `<p style="color: red; font-weight: bold;">Error rendering list: ${e.message}</p>`;
          return; // Stop execution
        }
        listDiv.innerHTML = html;
      }
      
      // --- Admin Approve/Deny Function ---
      function approveDenyRequest(requestID, newStatus) {
        const statusDiv = document.getElementById('approval-status');
        statusDiv.className = 'processing';
        statusDiv.innerText = `Processing request...`;
        
        google.script.run
          .withSuccessHandler(msg => {
            if (msg.startsWith('Error:')) { 
              statusDiv.className = 'error';
              statusDiv.innerText = msg.replace('Error: ', '');
            } else {
              statusDiv.className = 'success';
              statusDiv.innerText = msg;
            }
            const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
            loadPendingRequests(currentFilter);
            loadMyRequests();
            google.script.run.withSuccessHandler(user => {
              populateMyBalances(user.myBalances);
            }).getUserInfo();
          })
          .withFailureHandler(err => {
            statusDiv.className = 'error';
            statusDiv.innerText = err.message;
          })
          .webApproveDenyRequest(requestID, newStatus);
      }
      
      // --- Load My Schedule ---
      function loadMySchedule() {
        const statusDiv = document.getElementById('my-schedule-status');
        const displayDiv = document.getElementById('my-schedule-display');
        statusDiv.className = 'processing';
        statusDiv.innerText = 'Loading your schedule...';
        displayDiv.innerHTML = '';

        google.script.run
          .withSuccessHandler(populateMySchedule)
          .withFailureHandler(err => {
            statusDiv.className = 'error';
            statusDiv.innerText = err.message;
          })
          .webGetMySchedule();
      }

      // --- Populate My Schedule ---
      function populateMySchedule(scheduleData) {
        const statusDiv = document.getElementById('my-schedule-status');
        const displayDiv = document.getElementById('my-schedule-display');
        
        if (scheduleData.error) {
          statusDiv.className = 'error';
          statusDiv.innerText = scheduleData.error;
          return;
        }
        
        if (scheduleData.length === 0) {
          statusDiv.className = 'success';
          statusDiv.innerText = 'No schedule found for the next 7 days.';
          return;
        }

        statusDiv.className = '';
        statusDiv.innerText = '';
        statusDiv.style.visibility = 'hidden';

        let html = `
          <table class="schedule-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Day</th>
                <th>Status</th>
                <th>Shift Start</th>
                <th>Shift End</th>
              </tr>
            </thead>
            <tbody>
        `;

        const today = new Date();
        today.setHours(0,0,0,0); // Normalize today

        scheduleData.forEach(day => {
          const scheduleDate = new Date(day.date);
          const dayStr = scheduleDate.toLocaleDateString('en-US', { weekday: 'long' });
          const dateStr = formatDate(day.date);
          
          let trClass = '';
          if (scheduleDate.getTime() < today.getTime()) {
            trClass = 'day-past';
          } else if (scheduleDate.getTime() === today.getTime()) {
            trClass = 'day-today';
          }

          let statusClass = '';
          if (day.leaveType !== 'Present') {
            statusClass = 'status-leave';
          }

          html += `
            <tr class="${trClass}">
              <td>${dateStr}</td>
              <td>${dayStr}</td>
              <td class="${statusClass}">${day.leaveType}</td>
              <td>${day.startTime || '--:--'}</td>
              <td>${day.endTime || '--:--'}</td>
            </tr>
          `;
        });

        html += '</tbody></table>';
        displayDiv.innerHTML = html;
      }
      
      // --- Load History Report (MODIFIED) ---
      function loadHistoryReport() {
        const statusDiv = document.getElementById('my-history-status');
        const displayDiv = document.getElementById('history-report-display');
        const startDate = document.getElementById('history-start-date').value;
        const endDate = document.getElementById('history-end-date').value;
        
        let targetUserNames = [];
        
        if (selfRole === 'admin' || selfRole === 'superadmin') {
          const selectedOptions = document.getElementById('history-user-select').selectedOptions;
          if (selectedOptions.length === 0) {
            statusDiv.className = 'error';
            statusDiv.innerText = 'Please select at least one user to view.';
            return;
          }
          for (let option of selectedOptions) {
            // Dropdown value is now email, find the name
            const user = allUsersList.find(u => u.email === option.value);
            if (user) targetUserNames.push(user.name);
          }
        } else {
          // Agent is viewing their own
          targetUserNames.push(selfUserName);
        }
        
        if (!startDate || !endDate) {
          statusDiv.className = 'error';
          statusDiv.innerText = 'Please select a Start and End date to view.';
          return;
        }
        if (new Date(endDate) < new Date(startDate)) {
          statusDiv.className = 'error';
          statusDiv.innerText = 'End Date cannot be before Start Date.';
          return;
        }
        
        statusDiv.className = 'processing';
        statusDiv.innerText = `Loading history for ${targetUserNames.length} user(s)...`;
        displayDiv.innerHTML = '';
        lastHistoryData = null; // Clear old export data
        document.getElementById('export-csv-btn').style.display = 'none';
        
        google.script.run
          .withSuccessHandler(data => {
            if (data.error) {
              statusDiv.className = 'error';
              statusDiv.innerText = data.error;
              return;
            }
            
            statusDiv.className = 'success';
            statusDiv.innerText = `Displaying ${data.length} record(s).`;
            populateHistoryReport(data); // Call new table renderer
            lastHistoryData = data; // Save for export
            document.getElementById('export-csv-btn').style.display = 'inline-block'; // Show export button
          })
          .withFailureHandler(err => {
            statusDiv.className = 'error';
            statusDiv.innerText = err.message;
          })
          .webGetAdherenceRange(targetUserNames, startDate, endDate); // Call new backend function
      }
      
      // --- Populate History Report Table ---
      function populateHistoryReport(data) {
        const displayDiv = document.getElementById('history-report-display');
        
        if (!data || data.length === 0) {
          displayDiv.innerHTML = '<p>No adherence records found for the selected criteria.</p>';
          return;
        }

        const ex = (value) => {
          if (!value || value === 'No' || value === 0) return '0';
          const seconds = parseInt(value, 10);
          if (seconds > 0) return `<span class="highlight-red">${formatSeconds(seconds)}</span>`;
          return '0';
        };

        let html = `
          <table class="report-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Date</th>
                <th>Status</th>
                <th>Login</th>
                <th>Logout</th>
                <th>Tardy</th>
                <th>Early Leave</th>
                <th>Overtime</th>
                <th>Break Exceed</th>
                <th>Lunch Exceed</th>
              </tr>
            </thead>
            <tbody>
        `;

        data.forEach(row => {
          const totalBreakExceed = (parseInt(row.firstBreakExceed, 10) || 0) + (parseInt(row.lastBreakExceed, 10) || 0);
          
          html += `
            <tr>
              <td>${row.userName}</td>
              <td>${formatDate(row.date)}</td>
              <td>${row.leaveType || 'N/A'}</td>
              <td>${formatTime(row.login)}</td>
              <td>${formatTime(row.logout)}</td>
              <td>${ex(row.tardy)}</td>
              <td>${ex(row.earlyLeave)}</td>
              <td><span class="highlight-green">${formatSeconds(row.overtime)}</span></td>
              <td>${ex(totalBreakExceed)}</td>
              <td>${ex(row.lunchExceed)}</td>
            </tr>
          `;
        });

        html += '</tbody></table>';
        displayDiv.innerHTML = html;
      }
      
      // --- Export to CSV (for new multi-day format) ---
      function exportHistoryToCSV() {
        if (!lastHistoryData || lastHistoryData.length === 0) {
          alert("No data to export. Please 'View History' first.");
          return;
        }
        
        let csvContent = "data:text/csv;charset=utf-8,";
        // Add headers
        csvContent += "User,Date,Status,Login,Logout,Tardy (sec),Early Leave (sec),Overtime (sec),1st Break Exceed (sec),Lunch Exceed (sec),Last Break Exceed (sec)\r\n";
        
        lastHistoryData.forEach(data => {
          let row = [
            data.userName,
            formatDate(data.date),
            data.leaveType || 'N/A',
            formatTime(data.login),
            formatTime(data.logout),
            data.tardy || 0,
            data.earlyLeave || 0,
            data.overtime || 0,
            data.firstBreakExceed || 0,
            data.lunchExceed || 0,
            data.lastBreakExceed || 0
          ].join(",");
          csvContent += row + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `History_Report_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link); 
        link.click();
        document.body.removeChild(link);
      }
      
      // --- Submit Manual Punch ---
      function submitManualPunch() {
        const statusDiv = document.getElementById('manual-punch-status');
        try {
          const userEmail = document.getElementById('manual-punch-user').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user.");

          const action = document.getElementById('manual-punch-action').value;
          const date = document.getElementById('manual-punch-date').value;
          const time = document.getElementById('manual-punch-time').value;
          
          if (!action) throw new Error("Please select a punch action.");
          if (!date) throw new Error("Please select a date.");
          if (!time) throw new Error("Please select a time.");
          
          const timestamp = new Date(date + 'T' + time).toISOString();
          
          statusDiv.className = 'processing';
          statusDiv.innerText = `Processing "${action}" for ${user.name}...`;
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) {
                statusDiv.className = 'error';
                statusDiv.innerText = msg.replace('Error: ', '');
              } else {
                statusDiv.className = 'success';
                statusDiv.innerText = msg;
                document.getElementById('manual-punch-form').reset();
                document.getElementById('manual-punch-date').valueAsDate = new Date();
                document.getElementById('manual-punch-user').selectedIndex = 0;
                document.getElementById('manual-punch-action').selectedIndex = 0;
              }
            })
            .withFailureHandler(err => {
              statusDiv.className = 'error';
              statusDiv.innerText = err.message;
            })
            .webPunch(action, user.name, timestamp); 
            
        } catch(err) {
          statusDiv.className = 'error';
          statusDiv.innerText = err.message;
        }
      }
      
      // --- Submit Admin Leave Request (UPDATED) ---
      function submitAdminLeaveRequest() {
        const statusDiv = document.getElementById('admin-leave-status');
        try {
          const userEmail = document.getElementById('admin-leave-user').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user.");
          
          // const supervisorEmail = document.getElementById('admin-leave-supervisor').value; // REMOVED
          const leaveType = document.getElementById('admin-leave-type').value;
          const startDate = document.getElementById('admin-leave-start-date').value;
          let endDate = document.getElementById('admin-leave-end-date').value;
          const reason = document.getElementById('admin-leave-reason').value;

          // if (!supervisorEmail) throw new Error("Please select a supervisor."); // REMOVED
          if (!startDate) throw new Error("Please select a Start Date.");
          if (!endDate) endDate = startDate; 
          
          if (new Date(endDate) < new Date(startDate)) {
            throw new Error("End Date cannot be before Start Date.");
          }
          
          const requestObject = {
            // supervisorEmail: supervisorEmail, // REMOVED
            leaveType: leaveType,
            startDate: startDate,
            endDate: endDate,
            reason: reason
          };
          
          statusDiv.className = 'processing';
          statusDiv.innerText = `Submitting request for ${user.name}...`;
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                statusDiv.className = 'error';
                statusDiv.innerText = msg.replace('Error: ', '');
              } else {
                statusDiv.className = 'success';
                statusDiv.innerText = msg;
                document.getElementById('admin-leave-form').reset();
                document.getElementById('admin-leave-start-date').valueAsDate = new Date();
                
                // --- THIS IS THE FIX ---
                // Refresh admin's pending list
                const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
                loadPendingRequests(currentFilter);
                // --- END FIX ---
              }
            })
            .withFailureHandler(err => {
              statusDiv.className = 'error';
              statusDiv.innerText = err.message;
            })
            .webSubmitLeaveRequest(requestObject, user.email); // Pass target user email
          
        } catch (err) {
          statusDiv.className = 'error';
          statusDiv.innerText = err.message;
        }
      }
      
      // --- Submit Balance Adjustment ---
      function submitBalanceAdjustment() {
        const statusDiv = document.getElementById('balance-adjust-status');
        try {
          const userEmail = document.getElementById('balance-user-select').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user.");
          
          const leaveType = document.getElementById('balance-leave-type').value;
          const amount = parseFloat(document.getElementById('balance-amount').value);
          const reason = document.getElementById('balance-reason').value;

          if (isNaN(amount) || amount === 0) throw new Error("Please enter a valid, non-zero amount.");
          if (!reason) throw new Error("A reason is required for all adjustments.");

          statusDiv.className = 'processing';
          statusDiv.innerText = `Adjusting ${leaveType} balance for ${user.name}...`;

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                statusDiv.className = 'error';
                statusDiv.innerText = msg.replace('Error: ', '');
              } else {
                statusDiv.className = 'success';
                statusDiv.innerText = msg;
                document.getElementById('balance-adjustment-form').reset();
              }
            })
            .withFailureHandler(err => {
              statusDiv.className = 'error';
              statusDiv.innerText = err.message;
            })
            .webAdjustLeaveBalance(user.email, leaveType, amount, reason);

        } catch (err) {
          statusDiv.className = 'error';
          statusDiv.innerText = err.message;
        }
      }
      
      // --- Import Schedule CSV ---
      function importScheduleCSV() {
        const statusDiv = document.getElementById('csv-import-status');
        const fileInput = document.getElementById('csv-file-input');
        const file = fileInput.files[0];

        if (!file) {
          statusDiv.className = 'error';
          statusDiv.innerText = 'Please select a CSV file to import.';
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const text = e.target.result;
          const data = parseCSV(text);
          
          if (!data || data.length === 0) {
            statusDiv.className = 'error';
            statusDiv.innerText = 'File is empty or invalid. Could not parse any rows.';
            return;
          }

          // Validate headers
          const headers = data[0];
          if (!headers.Name || !headers.Date || !headers.Email) {
            statusDiv.className = 'error';
            statusDiv.innerText = 'Invalid CSV format. Must include headers: Name, Date, Email. (StartTime, EndTime, LeaveType are optional)';
            return;
          }

          statusDiv.className = 'processing';
          statusDiv.innerText = `Importing ${data.length} schedule records...`;

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                statusDiv.className = 'error';
                statusDiv.innerText = msg.replace('Error: ', '');
              } else {
                statusDiv.className = 'success';
                statusDiv.innerText = msg;
                fileInput.value = ''; // Clear the file input
              }
            })
            .withFailureHandler(err => {
              statusDiv.className = 'error';
              statusDiv.innerText = err.message;
            })
            .webImportScheduleCSV(data);
        };
        
        reader.onerror = function(e) {
          statusDiv.className = 'error';
          statusDiv.innerText = 'Error reading file: ' + e.message;
        };

        reader.readAsText(file);
      }

      // --- Simple CSV Parser ---
      function parseCSV(csvText) {
        const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
        if (lines.length < 2) return []; // Need header and at least one data row

        const headers = lines[0].split(',').map(h => h.trim());
        const result = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',');
          const obj = {};
          for (let j = 0; j < headers.length; j++) {
            obj[headers[j]] = values[j] ? values[j].trim() : '';
          }
          result.push(obj);
        }
        return result;
      }

      // --- Dashboard Functions (UPDATED) ---
      function getSelectedDashboardUsers() {
        const select = document.getElementById('dashboard-user-select');
        const selectedUsers = Array.from(select.selectedOptions).map(opt => opt.value); // These are emails
        if (selectedUsers.length === 0) {
          return ['ALL_USERS']; // Use 'ALL_USERS' to signal "My Team" or "All"
        }
        return selectedUsers;
      }

      function loadDashboard() {
        if (!chartsLoaded) {
          google.charts.setOnLoadCallback(loadDashboard);
          return;
        }
        const statusDiv = document.getElementById('dashboard-status');
        const userEmails = getSelectedDashboardUsers();
        const date = document.getElementById('dashboard-date').value;
        
        if (!date) {
           statusDiv.className = 'error';
           statusDiv.innerText = 'Please select a date for the dashboard.';
           return;
        }
        
        if (userEmails.length === 1 && userEmails[0] === 'ALL_USERS') {
           document.getElementById('dashboard-title').innerText = `Full Team Dashboard for ${formatDate(date)}`;
        } else {
           document.getElementById('dashboard-title').innerText = `Dashboard for ${userEmails.length} User(s) (${formatDate(date)})`;
        }
        
        statusDiv.className = 'processing';
        statusDiv.innerText = 'Loading dashboard data...';
        
        google.script.run
          .withSuccessHandler(drawDashboard)
          .withFailureHandler(err => {
            statusDiv.className = 'error';
            statusDiv.innerText = err.message;
          })
          .webGetDashboardData(userEmails, date); // Send selected user emails and date
      }
      
      function drawDashboard(data) {
        if (!data || data.error) {
          document.getElementById('dashboard-status').className = 'error';
          document.getElementById('dashboard-status').innerText = data.error || 'Failed to load dashboard data.';
          // Clear old charts
          document.getElementById('status-pie-chart').innerHTML = '';
          document.getElementById('adherence-bar-chart').innerHTML = '';
          document.getElementById('pending-leave-table').innerHTML = '';
          document.getElementById('adherence-detail-table').innerHTML = '';
          return;
        }
        
        document.getElementById('dashboard-status').className = 'success';
        document.getElementById('dashboard-status').innerText = 'Dashboard loaded successfully.';
        
        // 1. Draw Status Pie Chart
        const statusData = new google.visualization.DataTable();
        statusData.addColumn('string', 'Status');
        statusData.addColumn('number', 'Count');
        statusData.addRows(data.statusCounts);
        const pieOptions = { title: 'Current User Status', pieHole: 0.4, };
        const pieChart = new google.visualization.PieChart(document.getElementById('status-pie-chart'));
        pieChart.draw(statusData, pieOptions);

        // 2. Draw Adherence Bar Chart
        const adherenceData = new google.visualization.DataTable();
        adherenceData.addColumn('string', 'Metric');
        adherenceData.addColumn('number', 'Minutes');
        adherenceData.addRows([
          ['Total Tardy', data.totalAdherenceMetrics.totalTardy / 60],
          ['Total Early Leave', data.totalAdherenceMetrics.totalEarlyLeave / 60],
          ['Total Break Exceed', data.totalAdherenceMetrics.totalBreakExceed / 60],
          ['Total Lunch Exceed', data.totalAdherenceMetrics.totalLunchExceed / 60]
        ]);
        const barOptions = {
          title: 'Total Adherence Deviations (in Minutes)',
          legend: { position: 'none' },
        };
        const barChart = new google.visualization.BarChart(document.getElementById('adherence-bar-chart'));
        barChart.draw(adherenceData, barOptions);
        
        // 3. NEW: Draw Adherence Detail Table
        const detailTableData = new google.visualization.DataTable();
        detailTableData.addColumn('string', 'User');
        detailTableData.addColumn('string', 'Tardy');
        detailTableData.addColumn('string', 'Early Leave');
        detailTableData.addColumn('string', 'Overtime');
        detailTableData.addColumn('string', 'Break Exceed');
        detailTableData.addColumn('string', 'Lunch Exceed');
        detailTableData.addRows(data.individualAdherenceMetrics.map(user => {
          return [
            user.name,
            formatSeconds(user.tardy),
            formatSeconds(user.earlyLeave),
            formatSeconds(user.overtime),
            formatSeconds(user.breakExceed),
            formatSeconds(user.lunchExceed)
          ];
        }));
        const detailTableOptions = { showRowNumber: true, width: '100%', height: '100%', allowHtml: true, cssClassNames: { tableCell: 'report-table-cell', headerCell: 'report-table-header' } };
        const detailTable = new google.visualization.Table(document.getElementById('adherence-detail-table'));
        detailTable.draw(detailTableData, detailTableOptions);


        // 4. Draw Pending Leave Table
        const tableData = new google.visualization.DataTable();
        tableData.addColumn('string', 'Agent');
        tableData.addColumn('string', 'Type');
        tableData.addColumn('string', 'Start Date');
        tableData.addColumn('number', 'Days');
        // --- THIS IS THE FIX ---
        // The backend is now sending an OBJECT, not an array
        tableData.addRows(data.pendingRequests.map(req => {
          return [req.name, req.type, formatDate(req.startDate), req.days];
        }));
        // --- END FIX ---
        const tableOptions = { title: 'Pending Leave', showRowNumber: true, width: '100%', height: '100%' };
        const table = new google.visualization.Table(document.getElementById('pending-leave-table'));
        table.draw(tableData, tableOptions);
      }
      
      function saveMyTeam() {
        const select = document.getElementById('dashboard-user-select');
        const selectedUsers = Array.from(select.selectedOptions).map(opt => opt.value); // These are emails
        const statusDiv = document.getElementById('dashboard-status');
        
        if (selectedUsers.length === 0) {
          statusDiv.className = 'error';
          statusDiv.innerText = 'Please select at least one user to save as your team.';
          return;
        }
        
        statusDiv.className = 'processing';
        statusDiv.innerText = 'Saving "My Team"...';
        
        google.script.run
          .withSuccessHandler(msg => {
            statusDiv.className = 'success';
            statusDiv.innerText = msg;
          })
          .withFailureHandler(err => {
            statusDiv.className = 'error';
            statusDiv.innerText = err.message;
          })
          .webSaveMyTeam(selectedUsers); // Send emails
      }
      
      // --- UPDATED: This function NO LONGER auto-loads the dashboard ---
      function loadMyTeam(autoLoadDashboard = false) { 
        const statusDiv = document.getElementById('dashboard-status');
        statusDiv.className = 'processing';
        statusDiv.innerText = 'Loading "My Team"...';
        
        google.script.run
          .withSuccessHandler(teamEmails => {
            if (teamEmails && teamEmails.length > 0) {
              const select = document.getElementById('dashboard-user-select');
              Array.from(select.options).forEach(option => {
                option.selected = teamEmails.includes(option.value);
              });
              statusDiv.className = 'success';
              statusDiv.innerText = 'Loaded "My Team". Click "Load Dashboard" to view.';
              // --- FIX: Call loadDashboard ONLY if it's the first page load ---
              if (autoLoadDashboard) {
                loadDashboard();
              }
            } else {
              statusDiv.className = 'success';
              statusDiv.innerText = 'No "My Team" saved. Select users and click "Load Dashboard".';
              if (autoLoadDashboard) {
                loadDashboard(); // Load default
              }
            }
            
            // --- FIX: This is what was missing. ---
            // After loading the team, we must load the dashboard.
            if (!autoLoadDashboard) {
              loadDashboard();
            }
          })
          .withFailureHandler(err => {
            statusDiv.className = 'error';
            statusDiv.innerText = err.message;
            if (autoLoadDashboard) {
              loadDashboard();
            }
          })
          .webGetMyTeam();
      }

      // --- NEW: Submit Reporting Line Change ---
      function submitReportingLineChange() {
        const statusDiv = document.getElementById('reporting-line-status');
        try {
          const userEmail = document.getElementById('reporting-line-user').value;
          const newSupervisorEmail = document.getElementById('reporting-line-supervisor').value;

          if (!userEmail) throw new Error("Please select a user to move.");
          if (!newSupervisorEmail) throw new Error("Please select a new supervisor.");
          if (userEmail === newSupervisorEmail) throw new Error("A user cannot be their own supervisor.");

          statusDiv.className = 'processing';
          statusDiv.innerText = 'Processing reporting line change...';

          google.script.run
            .withSuccessHandler(msg => {
              statusDiv.className = 'success';
              statusDiv.innerText = msg;
              // Clear form
              document.getElementById('reporting-line-user').selectedIndex = 0;
              document.getElementById('reporting-line-supervisor').selectedIndex = 0;
            })
            .withFailureHandler(err => {
              statusDiv.className = 'error';
              statusDiv.innerText = err.message;
            })
            .webUpdateReportingLine(userEmail, newSupervisorEmail);

        } catch (err) {
          statusDiv.className = 'error';
          statusDiv.innerText = err.message;
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function() {
        loadUserInfo(); 
        document.getElementById('schedule-start-date').valueAsDate = new Date();
        document.getElementById('leave-start-date').valueAsDate = new Date();
        document.getElementById('history-start-date').valueAsDate = new Date(); 
        document.getElementById('history-end-date').valueAsDate = new Date(); 
        document.getElementById('manual-punch-date').valueAsDate = new Date(); 
        document.getElementById('admin-leave-start-date').valueAsDate = new Date(); 
        document.getElementById('dashboard-date').valueAsDate = new Date(); // NEW: Set dashboard date
      });
    </script>
  </body>
</html>
